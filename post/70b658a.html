<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CLobster+Two:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"nimbusk.cc","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.21.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="课程实录(08)Logstash安装与导入数据Movies示例数据集ES Mapping： 123456789101112PUT movies&#123;  &quot;settings&quot; : &#123;    &quot;number_of_shards&quot; : &quot;1&quot;,    &quot;number_of_replicas&quot; : &quot;">
<meta property="og:type" content="article">
<meta property="og:title" content="极客时间-ElasticSearch">
<meta property="og:url" content="https://nimbusk.cc/post/70b658a.html">
<meta property="og:site_name" content="NimbusK&#39;s Blog">
<meta property="og:description" content="课程实录(08)Logstash安装与导入数据Movies示例数据集ES Mapping： 123456789101112PUT movies&#123;  &quot;settings&quot; : &#123;    &quot;number_of_shards&quot; : &quot;1&quot;,    &quot;number_of_replicas&quot; : &quot;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://nimbusk.cc/post/70b658a/AutoCapture_2020-07-11_093758.jpg">
<meta property="og:image" content="https://nimbusk.cc/post/70b658a/AutoCapture_2020-07-11_103828.jpg">
<meta property="og:image" content="https://nimbusk.cc/post/70b658a/AutoCapture_2020-07-11_110449.jpg">
<meta property="og:image" content="https://nimbusk.cc/post/70b658a/AutoCapture_2020-07-11_113536.jpg">
<meta property="og:image" content="https://nimbusk.cc/post/70b658a/AutoCapture_2020-07-11_115912.jpg">
<meta property="og:image" content="https://nimbusk.cc/post/70b658a/AutoCapture_2020-07-11_133509.jpg">
<meta property="og:image" content="https://nimbusk.cc/post/70b658a/AutoCapture_2020-07-11_173010.jpg">
<meta property="og:image" content="https://nimbusk.cc/post/70b658a/AutoCapture_2020-07-11_213211.jpg">
<meta property="og:image" content="https://nimbusk.cc/post/70b658a/AutoCapture_2020-07-11_215242.jpg">
<meta property="og:image" content="https://nimbusk.cc/post/70b658a/AutoCapture_2020-07-11_232645.jpg">
<meta property="og:image" content="https://nimbusk.cc/post/70b658a/AutoCapture_2020-07-12_105807.jpg">
<meta property="og:image" content="https://nimbusk.cc/post/70b658a/AutoCapture_2020-07-12_123744.jpg">
<meta property="og:image" content="https://nimbusk.cc/post/70b658a/AutoCapture_2020-07-12_125601.jpg">
<meta property="og:image" content="https://nimbusk.cc/post/70b658a/AutoCapture_2020-07-12_125752.jpg">
<meta property="og:image" content="https://nimbusk.cc/post/70b658a/AutoCapture_2020-07-12_130022.jpg">
<meta property="og:image" content="https://nimbusk.cc/post/70b658a/AutoCapture_2020-07-26_090151.jpg">
<meta property="og:image" content="https://nimbusk.cc/post/70b658a/AutoCapture_2020-06-20_174345.jpg">
<meta property="og:image" content="https://nimbusk.cc/post/70b658a/AutoCapture_2020-06-20_175410.jpg">
<meta property="og:image" content="https://nimbusk.cc/post/70b658a/AutoCapture_2020-06-20_181355.jpg">
<meta property="og:image" content="https://nimbusk.cc/post/70b658a/AutoCapture_2020-06-29_222348.jpg">
<meta property="og:image" content="https://nimbusk.cc/post/70b658a/AutoCapture_2020-06-29_222750.jpg">
<meta property="article:published_time" content="2020-06-20T17:26:34.000Z">
<meta property="article:modified_time" content="2024-10-28T20:30:21.000Z">
<meta property="article:author" content="nimbusk">
<meta property="article:tag" content="ElasticSearch">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://nimbusk.cc/post/70b658a/AutoCapture_2020-07-11_093758.jpg">


<link rel="canonical" href="https://nimbusk.cc/post/70b658a.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://nimbusk.cc/post/70b658a.html","path":"post/70b658a.html","title":"极客时间-ElasticSearch"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>极客时间-ElasticSearch | NimbusK's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">NimbusK's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%BE%E7%A8%8B%E5%AE%9E%E5%BD%95"><span class="nav-number">1.</span> <span class="nav-text">课程实录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#08-Logstash%E5%AE%89%E8%A3%85%E4%B8%8E%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="nav-number">1.1.</span> <span class="nav-text">(08)Logstash安装与导入数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#09-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%EF%BC%9A%E7%B4%A2%E5%BC%95%E3%80%81%E6%96%87%E6%A1%A3%E5%92%8CREST-API"><span class="nav-number">1.2.</span> <span class="nav-text">(09)基本概念：索引、文档和REST API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E6%A1%A3-Document"><span class="nav-number">1.2.1.</span> <span class="nav-text">文档(Document)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#JSON%E6%96%87%E6%A1%A3"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">JSON文档</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%96%87%E6%A1%A3%E7%9A%84%E5%85%83%E6%95%B0%E6%8D%AE"><span class="nav-number">1.2.1.2.</span> <span class="nav-text">文档的元数据</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95"><span class="nav-number">1.2.2.</span> <span class="nav-text">索引</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E7%9A%84%E4%B8%8D%E5%90%8C%E8%AF%AD%E6%84%8F"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">索引的不同语意</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Type%E5%AD%97%E6%AE%B5"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">Type字段</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%BD%E8%B1%A1%E7%B1%BB%E6%AF%94"><span class="nav-number">1.2.3.</span> <span class="nav-text">与关系型数据库抽象类比</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#REST-API"><span class="nav-number">1.2.4.</span> <span class="nav-text">REST API</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%EF%BC%9A%E8%8A%82%E7%82%B9%E3%80%81%E9%9B%86%E7%BE%A4%E3%80%81%E5%88%86%E7%89%87%E5%8F%8A%E5%89%AF%E6%9C%AC"><span class="nav-number">1.3.</span> <span class="nav-text">(10)基本概念：节点、集群、分片及副本</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%8F%AF%E7%94%A8%E6%80%A7%E4%B8%8E%E6%89%A9%E5%B1%95%E6%80%A7"><span class="nav-number">1.3.1.</span> <span class="nav-text">分布式系统的可用性与扩展性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%89%B9%E6%80%A7"><span class="nav-number">1.3.2.</span> <span class="nav-text">分布式特性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8A%82%E7%82%B9"><span class="nav-number">1.3.3.</span> <span class="nav-text">节点</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Master-eligible-nodes-%E4%B8%8E-Master-Node"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">Master-eligible nodes 与 Master Node</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Data-Node-%E4%B8%8E-Coordinating-Node"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">Data Node 与 Coordinating Node</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%B6%E5%AE%83%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%8A%82%E7%82%B9"><span class="nav-number">1.3.3.3.</span> <span class="nav-text">其它类型的节点</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E7%89%87%EF%BC%88Primary-Shard-amp-Replica-Shard%EF%BC%89"><span class="nav-number">1.3.4.</span> <span class="nav-text">分片（Primary Shard &amp; Replica Shard）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%86%E7%89%87%E7%9A%84%E8%AE%BE%E5%AE%9A"><span class="nav-number">1.3.4.1.</span> <span class="nav-text">分片的设定</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E6%A1%A3%E7%9A%84CRUD"><span class="nav-number">1.3.5.</span> <span class="nav-text">文档的CRUD</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#BULK-API"><span class="nav-number">1.3.5.1.</span> <span class="nav-text">BULK API</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E8%AF%BB%E5%8F%96mget%E4%B8%8E%E6%89%B9%E9%87%8F%E6%9F%A5%E8%AF%A2msearch"><span class="nav-number">1.3.5.2.</span> <span class="nav-text">批量读取mget与批量查询msearch</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.4.</span> <span class="nav-text">(12)倒排索引介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E7%9A%84%E6%A0%B8%E5%BF%83%E7%BB%84%E6%88%90"><span class="nav-number">1.4.1.</span> <span class="nav-text">倒排索引的核心组成</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-%E9%80%9A%E8%BF%87Analyzer%E8%BF%9B%E8%A1%8C%E5%88%86%E8%AF%8D"><span class="nav-number">1.5.</span> <span class="nav-text">(13)通过Analyzer进行分词</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Analysis-%E4%B8%8E-Analyzer"><span class="nav-number">1.5.1.</span> <span class="nav-text">Analysis 与 Analyzer</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Analyzer%E7%9A%84%E7%BB%84%E6%88%90"><span class="nav-number">1.5.1.1.</span> <span class="nav-text">Analyzer的组成</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-Search-API%E6%A6%82%E8%A7%88"><span class="nav-number">1.6.</span> <span class="nav-text">(14)Search API概览</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%90%9C%E7%B4%A2%E7%9A%84%E7%9B%B8%E5%85%B3%E6%80%A7Relevance"><span class="nav-number">1.6.1.</span> <span class="nav-text">搜索的相关性Relevance</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A1%A1%E9%87%8F%E7%9B%B8%E5%85%B3%E6%80%A7"><span class="nav-number">1.6.2.</span> <span class="nav-text">衡量相关性</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15-URI-Search%E8%AF%A6%E8%A7%A3"><span class="nav-number">1.7.</span> <span class="nav-text">(15)URI Search详解</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Query-String-Syntax"><span class="nav-number">1.7.1.</span> <span class="nav-text">Query String Syntax</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-Request-Body-%E4%B8%8E-Query-DSL%E7%AE%80%E4%BB%8B"><span class="nav-number">1.8.</span> <span class="nav-text">(16)Request Body 与 Query DSL简介</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC%E5%AD%97%E6%AE%B5"><span class="nav-number">1.8.1.</span> <span class="nav-text">脚本字段</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-Query-String-%E4%B8%8E-Simple-Query-String%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.9.</span> <span class="nav-text">(17)Query String 与 Simple Query String查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#18-Dynamic-Mapping%E5%92%8C%E5%B8%B8%E8%A7%81%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.10.</span> <span class="nav-text">(18)Dynamic Mapping和常见字段类型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.10.1.</span> <span class="nav-text">字段的数据类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFDynamic-Mapping"><span class="nav-number">1.10.2.</span> <span class="nav-text">什么是Dynamic Mapping</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%87%AA%E5%8A%A8%E8%AF%86%E5%88%AB"><span class="nav-number">1.10.2.1.</span> <span class="nav-text">类型的自动识别</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%83%BD%E5%90%A6%E6%94%B9mapping%E7%9A%84%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.10.2.2.</span> <span class="nav-text">能否改mapping的字段类型</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89Mapping%E7%9A%84%E4%B8%80%E4%BA%9B%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.10.2.3.</span> <span class="nav-text">自定义Mapping的一些建议</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#index%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.10.2.4.</span> <span class="nav-text">index优化建议</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#20-%E5%A4%9A%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.11.</span> <span class="nav-text">(20)多字段类型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B2%BE%E7%A1%AE%E5%80%BC-Exact-Values-%E4%B8%8E-%E5%85%A8%E6%96%87%E6%9C%AC-Full-text"><span class="nav-number">1.11.1.</span> <span class="nav-text">精确值(Exact Values) 与 全文本(Full text)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E8%AF%8D"><span class="nav-number">1.11.2.</span> <span class="nav-text">自定义分词</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Character-Filters"><span class="nav-number">1.11.2.1.</span> <span class="nav-text">Character Filters</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Tokenizer"><span class="nav-number">1.11.2.2.</span> <span class="nav-text">Tokenizer</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Token-Filter"><span class="nav-number">1.11.2.3.</span> <span class="nav-text">Token Filter</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E4%B8%80%E4%B8%AACustom-Analyzer"><span class="nav-number">1.11.2.4.</span> <span class="nav-text">设置一个Custom Analyzer</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%BE%E7%A8%8B%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.11.3.</span> <span class="nav-text">课程示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E8%AF%8D%E7%B4%A2%E5%BC%95%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.11.4.</span> <span class="nav-text">自定义分词索引示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#21-Index-Template%E5%92%8CDynamic-Template"><span class="nav-number">1.12.</span> <span class="nav-text">(21)Index Template和Dynamic Template</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFIndex-Template"><span class="nav-number">1.12.1.</span> <span class="nav-text">什么是Index Template</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Index-Template%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F"><span class="nav-number">1.12.2.</span> <span class="nav-text">Index Template的工作方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFDynamic-Template"><span class="nav-number">1.12.3.</span> <span class="nav-text">什么是Dynamic Template</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AF%BE%E7%A8%8B%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.12.3.1.</span> <span class="nav-text">课程代码示例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E9%98%85%E8%AF%BB"><span class="nav-number">1.12.4.</span> <span class="nav-text">相关阅读</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#22-ES%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90%E7%AE%80%E4%BB%8B"><span class="nav-number">1.13.</span> <span class="nav-text">(22)ES聚合分析简介</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%81%9A%E5%90%88-Aggregation"><span class="nav-number">1.13.1.</span> <span class="nav-text">什么是聚合(Aggregation)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%81%9A%E5%90%88%E7%9A%84%E5%88%86%E7%B1%BB"><span class="nav-number">1.13.2.</span> <span class="nav-text">聚合的分类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Bucket-amp-Metric"><span class="nav-number">1.13.3.</span> <span class="nav-text">Bucket &amp; Metric</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%80%E4%B8%AABucket%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="nav-number">1.13.3.1.</span> <span class="nav-text">一个Bucket的例子</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%80%E4%B8%AAMetrics%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.13.3.2.</span> <span class="nav-text">一个Metrics示例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#24-%E5%9F%BA%E4%BA%8E%E8%AF%8D%E9%A1%B9-Term-%E5%92%8C%E5%9F%BA%E4%BA%8E%E5%85%A8%E6%96%87%E7%9A%84%E6%90%9C%E7%B4%A2"><span class="nav-number">1.14.</span> <span class="nav-text">(24)基于词项(Term)和基于全文的搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8ETerm%E7%9A%84%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.14.1.</span> <span class="nav-text">基于Term的查询</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Term%E6%9F%A5%E8%AF%A2%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.14.1.1.</span> <span class="nav-text">Term查询示例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%8D%E5%90%88%E6%9F%A5%E8%AF%A2-Constant-Score-%E8%BD%AC%E4%B8%BAFilter"><span class="nav-number">1.14.2.</span> <span class="nav-text">复合查询 - Constant Score 转为Filter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E5%85%A8%E6%96%87%E7%9A%84%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.14.3.</span> <span class="nav-text">基于全文的查询</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#25-%E7%BB%93%E6%9E%84%E5%8C%96%E6%90%9C%E7%B4%A2"><span class="nav-number">1.15.</span> <span class="nav-text">(25)结构化搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%93%E6%9E%84%E5%8C%96%E6%95%B0%E6%8D%AE"><span class="nav-number">1.15.1.</span> <span class="nav-text">结构化数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ES%E4%B8%AD%E7%9A%84%E7%BB%93%E6%9E%84%E5%8C%96%E6%90%9C%E7%B4%A2"><span class="nav-number">1.15.2.</span> <span class="nav-text">ES中的结构化搜索</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%BE%E7%A8%8B%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-1"><span class="nav-number">1.15.3.</span> <span class="nav-text">课程代码示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#26-%E6%90%9C%E7%B4%A2%E7%9B%B8%E5%85%B3%E6%80%A7%E7%AE%97%E6%B3%95"><span class="nav-number">1.16.</span> <span class="nav-text">(26)搜索相关性算法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E6%80%A7%E5%92%8C%E7%9B%B8%E5%85%B3%E6%80%A7%E7%AE%97%E5%88%86"><span class="nav-number">1.16.1.</span> <span class="nav-text">相关性和相关性算分</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%8D%E9%A2%91TF"><span class="nav-number">1.16.2.</span> <span class="nav-text">词频TF</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%86%E6%96%87%E6%A1%A3%E9%A2%91%E7%8E%87IDF"><span class="nav-number">1.16.3.</span> <span class="nav-text">逆文档频率IDF</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TF-IDF%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="nav-number">1.16.4.</span> <span class="nav-text">TF-IDF的概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BM25"><span class="nav-number">1.16.5.</span> <span class="nav-text">BM25</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Boosting-Relevance"><span class="nav-number">1.16.5.1.</span> <span class="nav-text">Boosting Relevance</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E9%98%85%E8%AF%BB-1"><span class="nav-number">1.16.6.</span> <span class="nav-text">相关阅读</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#27-Query-amp-Filtering%E4%B8%8E%E5%A4%9A%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%9A%E5%AD%97%E6%AE%B5%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.17.</span> <span class="nav-text">(27)Query &amp; Filtering与多字符串多字段查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Query-Context-amp-Filter-Context"><span class="nav-number">1.17.1.</span> <span class="nav-text">Query Context &amp; Filter Context</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E7%BB%84%E5%90%88%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.17.2.</span> <span class="nav-text">条件组合示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bool%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.17.3.</span> <span class="nav-text">bool查询</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#bool%E6%9F%A5%E8%AF%A2%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.17.3.1.</span> <span class="nav-text">bool查询示例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E5%BA%A6%E7%AE%97%E5%88%86%E5%BD%B1%E5%93%8D"><span class="nav-number">1.17.3.2.</span> <span class="nav-text">相关度算分影响</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E7%AE%97%E5%88%86%E5%AD%97%E6%AE%B5boosting"><span class="nav-number">1.17.4.</span> <span class="nav-text">控制算分字段boosting</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#boosting%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.17.4.1.</span> <span class="nav-text">boosting示例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#28-%E5%8D%95%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%9A%E5%AD%97%E6%AE%B5%E6%9F%A5%E8%AF%A2Disjunction-Max-Query"><span class="nav-number">1.18.</span> <span class="nav-text">(28)单字符串多字段查询Disjunction Max Query</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.18.1.</span> <span class="nav-text">查询示例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AE%97%E5%88%86%E8%BF%87%E7%A8%8B%E8%A7%A3%E6%9E%90"><span class="nav-number">1.18.1.1.</span> <span class="nav-text">算分过程解析</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Disjunction-Max-Query%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.18.2.</span> <span class="nav-text">Disjunction Max Query查询</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E7%A4%BA%E4%BE%8B-1"><span class="nav-number">1.18.2.1.</span> <span class="nav-text">查询示例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Tie-Breaker%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4"><span class="nav-number">1.18.2.2.</span> <span class="nav-text">Tie Breaker参数调整</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#29-%E5%8D%95%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%9A%E5%AD%97%E6%AE%B5%E6%9F%A5%E8%AF%A2Multi-Match"><span class="nav-number">1.19.</span> <span class="nav-text">(29)单字符串多字段查询Multi Match</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%89%E7%A7%8D%E5%9C%BA%E6%99%AF"><span class="nav-number">1.19.1.</span> <span class="nav-text">三种场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Multi-Match-Query"><span class="nav-number">1.19.2.</span> <span class="nav-text">Multi Match Query</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B7%A8%E5%AD%97%E6%AE%B5%E6%90%9C%E7%B4%A2"><span class="nav-number">1.19.3.</span> <span class="nav-text">跨字段搜索</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#30-%E5%A4%9A%E8%AF%AD%E8%A8%80%E5%8F%8A%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E4%B8%8E%E6%A3%80%E7%B4%A2"><span class="nav-number">1.20.</span> <span class="nav-text">(30)多语言及中文分词与检索</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E4%B8%8E%E6%9F%A5%E8%AF%A2Recall"><span class="nav-number">1.20.1.</span> <span class="nav-text">自然语言与查询Recall</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%B7%E5%90%88%E5%A4%9A%E8%AF%AD%E8%A8%80%E6%8C%91%E6%88%98"><span class="nav-number">1.20.2.</span> <span class="nav-text">混合多语言挑战</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E8%AF%8D%E6%8C%91%E6%88%98"><span class="nav-number">1.20.3.</span> <span class="nav-text">分词挑战</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#52-Ingest-Pipeline-amp-Painless-Script"><span class="nav-number">1.21.</span> <span class="nav-text">(52)Ingest Pipeline &amp; Painless Script</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%83%8C%E6%99%AF"><span class="nav-number">1.21.1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Ingest-Node"><span class="nav-number">1.21.2.</span> <span class="nav-text">Ingest Node</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Pipeline-amp-Processor"><span class="nav-number">1.21.2.1.</span> <span class="nav-text">Pipeline &amp; Processor</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Ingest-Node-v-s-Logstash"><span class="nav-number">1.21.2.2.</span> <span class="nav-text">Ingest Node v.s Logstash</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Painless%E7%AE%80%E4%BB%8B"><span class="nav-number">1.21.3.</span> <span class="nav-text">Painless简介</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%94%A8%E9%80%94"><span class="nav-number">1.21.3.1.</span> <span class="nav-text">用途</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.21.3.2.</span> <span class="nav-text">示例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#53-%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1%E5%AE%9E%E4%BE%8B%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.22.</span> <span class="nav-text">(53)数据建模实例与最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1%EF%BC%9F"><span class="nav-number">1.22.1.</span> <span class="nav-text">什么是数据建模？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1%E8%BF%87%E7%A8%8B"><span class="nav-number">1.22.2.</span> <span class="nav-text">数据建模过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E6%A8%A1%E6%AD%A5%E9%AA%A4"><span class="nav-number">1.22.3.</span> <span class="nav-text">建模步骤</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B%EF%BC%9AText-v-s-Keyword"><span class="nav-number">1.22.3.1.</span> <span class="nav-text">字段类型：Text v.s Keyword</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B%EF%BC%9A%E7%BB%93%E6%9E%84%E5%8C%96%E6%95%B0%E6%8D%AE"><span class="nav-number">1.22.3.2.</span> <span class="nav-text">字段类型：结构化数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%90%9C%E7%B4%A2%E8%A7%92%E5%BA%A6"><span class="nav-number">1.22.3.3.</span> <span class="nav-text">搜索角度</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%81%9A%E5%90%88%E5%8F%8A%E6%8E%92%E5%BA%8F%E8%A7%92%E5%BA%A6"><span class="nav-number">1.22.3.4.</span> <span class="nav-text">聚合及排序角度</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%A2%9D%E5%A4%96%E5%AD%98%E5%82%A8%E8%A7%92%E5%BA%A6"><span class="nav-number">1.22.3.5.</span> <span class="nav-text">额外存储角度</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1%E7%9A%84%E6%A1%88%E4%BE%8B"><span class="nav-number">1.22.4.</span> <span class="nav-text">一个数据建模的案例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#DEMO"><span class="nav-number">1.22.4.1.</span> <span class="nav-text">DEMO</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E6%88%98"><span class="nav-number">2.</span> <span class="nav-text">实战</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="nimbusk"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">nimbusk</p>
  <div class="site-description" itemprop="description">写好一个博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">78</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">131</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/nimbusking" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;nimbusking" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:kemivong@hotmail.com" title="E-Mail → mailto:kemivong@hotmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://nimbusk.cc/post/70b658a.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="nimbusk">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NimbusK's Blog">
      <meta itemprop="description" content="写好一个博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="极客时间-ElasticSearch | NimbusK's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          极客时间-ElasticSearch
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">

  
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-20 17:26:34" itemprop="dateCreated datePublished" datetime="2020-06-20T17:26:34+00:00">2020-06-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2024-10-28 20:30:21" itemprop="dateModified" datetime="2024-10-28T20:30:21+00:00">2024-10-28</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/" itemprop="url" rel="index"><span itemprop="name">极客时间</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="课程实录"><a href="#课程实录" class="headerlink" title="课程实录"></a>课程实录</h2><h3 id="08-Logstash安装与导入数据"><a href="#08-Logstash安装与导入数据" class="headerlink" title="(08)Logstash安装与导入数据"></a>(08)Logstash安装与导入数据</h3><p><a href="70b658a/movies.csv">Movies示例数据集</a><br>ES Mapping：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT movies</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;excludes&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;_id&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>logstash.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; &quot;/Users/yiruan/dev/elk7/logstash-7.0.1/bin/movies.csv&quot;</span><br><span class="line">    start_position =&gt; &quot;beginning&quot;</span><br><span class="line">    sincedb_path =&gt; &quot;/dev/null&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">  csv &#123;</span><br><span class="line">    separator =&gt; &quot;,&quot;</span><br><span class="line">    columns =&gt; [&quot;id&quot;,&quot;content&quot;,&quot;genre&quot;]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  mutate &#123;</span><br><span class="line">    split =&gt; &#123; &quot;genre&quot; =&gt; &quot;|&quot; &#125;</span><br><span class="line">    remove_field =&gt; [&quot;path&quot;, &quot;host&quot;,&quot;@timestamp&quot;,&quot;message&quot;]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  mutate &#123;</span><br><span class="line"></span><br><span class="line">    split =&gt; [&quot;content&quot;, &quot;(&quot;]</span><br><span class="line">    add_field =&gt; &#123; &quot;title&quot; =&gt; &quot;%&#123;[content][0]&#125;&quot;&#125;</span><br><span class="line">    add_field =&gt; &#123; &quot;year&quot; =&gt; &quot;%&#123;[content][1]&#125;&quot;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  mutate &#123;</span><br><span class="line">    convert =&gt; &#123;</span><br><span class="line">      &quot;year&quot; =&gt; &quot;integer&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    strip =&gt; [&quot;title&quot;]</span><br><span class="line">    remove_field =&gt; [&quot;path&quot;, &quot;host&quot;,&quot;@timestamp&quot;,&quot;message&quot;,&quot;content&quot;]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">   elasticsearch &#123;</span><br><span class="line">     hosts =&gt; &quot;http://localhost:9200&quot;</span><br><span class="line">     index =&gt; &quot;movies&quot;</span><br><span class="line">     document_id =&gt; &quot;%&#123;id&#125;&quot;</span><br><span class="line">   &#125;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="09-基本概念：索引、文档和REST-API"><a href="#09-基本概念：索引、文档和REST-API" class="headerlink" title="(09)基本概念：索引、文档和REST API"></a>(09)基本概念：索引、文档和REST API</h3><h4 id="文档-Document"><a href="#文档-Document" class="headerlink" title="文档(Document)"></a>文档(Document)</h4><ul>
<li>Elasticsearch是面向文档的，文档是所有可搜索数据的最小单位<ul>
<li>日志文件中的日志项</li>
<li>一本电影的具体信息 / 一张唱片的详细信息</li>
<li>MP3播放器里的一首歌 / 一篇PDF文档中的具体内容</li>
</ul>
</li>
<li>文档会被序列化成JSON格式，保存在Elasticserach中<ul>
<li>JSON对象由字段组成</li>
<li>每个字段都有对应的字段类型（字符串、数值、布尔、日期、二进制、范围类型）</li>
</ul>
</li>
<li>每个文档都有一个Unique ID<ul>
<li>你可以自己指定ID</li>
<li>或者通过Elasticsearch自动生成</li>
</ul>
</li>
</ul>
<span id="more"></span>

<h5 id="JSON文档"><a href="#JSON文档" class="headerlink" title="JSON文档"></a>JSON文档</h5><ul>
<li>一篇文章包含了一系列的字段，类似数据库表中的一条记录。</li>
<li>JSON文档，格式灵活，不需要预先定义格式<ul>
<li>字段的类型可以指定或者通过Elasticsearch自动推算</li>
<li>支持数组/支持嵌套<br><img data-src="70b658a/AutoCapture_2020-07-11_093758.jpg" alt="CSV流文件处理后示例"></li>
</ul>
</li>
</ul>
<p><strong>注：</strong>在课程中，通过一个CSV源文件，再经过logstash处理后输出到ES中到文档存储格式</p>
<h5 id="文档的元数据"><a href="#文档的元数据" class="headerlink" title="文档的元数据"></a>文档的元数据</h5><p>一篇文档示例</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;movies&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">14.69302</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;year&quot;</span> <span class="punctuation">:</span> <span class="number">1995</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;@version&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;genre&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;Adventure&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;Animations&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;Children&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;Comedy&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;Fantasy&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Toy Story&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>元数据用于标注文档的相关信息</p>
<ul>
<li>_index - 文档所属的索引名</li>
<li>_type - 文档所属的类型名</li>
<li>_id - 文档唯一id</li>
<li>_source - 文档的原始JSON数据</li>
<li>_all - 整合所有自断内容到该字段，从7.0开始已被废除</li>
<li>_version - 文档到版本信息：大并发读写的时候，会很有用</li>
<li>_score - 相关性打分</li>
</ul>
<h4 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h4><p>Index - 所以是文档的容器，是一类文档的结合</p>
<ul>
<li>Index体现了逻辑的概念：每个索引都有自己的Mapping定义，用于定义包含的文档的字段名和字段类型。</li>
<li>Shard体现了物理空间的概念：索引中的数据分散在Shard分片上</li>
</ul>
<p>索引中可以设置Mapping与Settings</p>
<ul>
<li>Mapping定义文档字段的类型</li>
<li>Setting定义不同到数据分布：要用多少分片，数据最后是怎么分布到</li>
</ul>
<p>例如，上面那个电影信息的文档的索引结构就可以是如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;movies&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;settings&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;index&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;creation_date&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1552737458543&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;number_of_shards&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;number_of_replicas&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;uuid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Qnd7lMrnQPGdaeJ9oR0tfQ&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;version&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;created&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;6060299&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;provided_name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;movies&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="索引的不同语意"><a href="#索引的不同语意" class="headerlink" title="索引的不同语意"></a>索引的不同语意</h5><ul>
<li>名词：一个Elasticsearch集群中，可以创建很多个不同的索引</li>
<li>动词：保存一个文档到Elasticsearch的过程也叫索引（indexing）<ul>
<li>ES中，创建一个倒排索引到过程</li>
</ul>
</li>
<li>通用型的名词：一个B树索引，一个倒排索引</li>
</ul>
<h5 id="Type字段"><a href="#Type字段" class="headerlink" title="Type字段"></a>Type字段</h5><p>在7.0之前，一个Index可以设置多个Types<br>从6.0开始，Type已经被废弃。<br>从7.0开始，一个索引<strong>只能创建一个</strong> type - “_doc”</p>
<h4 id="与关系型数据库抽象类比"><a href="#与关系型数据库抽象类比" class="headerlink" title="与关系型数据库抽象类比"></a>与关系型数据库抽象类比</h4><p>整体上类比的可能不是那么恰当</p>
<ul>
<li>关系型数据库中表的概念 -&gt; ES中的索引</li>
<li>关系型数据库中每一条记录 -&gt; ES中的文档</li>
<li>关系型数据库中的每个字段 -&gt; ES文档中的一个字段</li>
</ul>
<h4 id="REST-API"><a href="#REST-API" class="headerlink" title="REST API"></a>REST API</h4><p>方便各种语言整合调用，只需要直接通过调用REST API即可<br>查看每个索引占用的内存：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/indices?v&amp;h=i,tm&amp;s=tm:desc</span><br></pre></td></tr></table></figure>

<h3 id="10-基本概念：节点、集群、分片及副本"><a href="#10-基本概念：节点、集群、分片及副本" class="headerlink" title="(10)基本概念：节点、集群、分片及副本"></a>(10)基本概念：节点、集群、分片及副本</h3><h4 id="分布式系统的可用性与扩展性"><a href="#分布式系统的可用性与扩展性" class="headerlink" title="分布式系统的可用性与扩展性"></a>分布式系统的可用性与扩展性</h4><ul>
<li>高可用性<ul>
<li>服务可用性 - 允许有节点停止服务</li>
<li>数据可用性 - 部分节点丢失，不会丢失数据</li>
</ul>
</li>
<li>可扩展性<ul>
<li>请求量提升 / 数据的不断增长（将数据分布到所有节点上）</li>
</ul>
</li>
</ul>
<h4 id="分布式特性"><a href="#分布式特性" class="headerlink" title="分布式特性"></a>分布式特性</h4><ul>
<li>Elasticsearch的分布式架构的好处<ul>
<li>存储水平扩容</li>
<li>提供系统的可用性，部分节点停止服务，整个集群的服务不受影响</li>
</ul>
</li>
<li>Elasticsearch的分布式架构<ul>
<li>不同的集群可以通过不同的名字来区分，默认名字：“elasticsearch”</li>
<li>通过配置文件修改，或者在命令行中直接指定：-E cluster.name=geektime进行设定</li>
<li>一个集群可以有一个或者多个节点</li>
</ul>
</li>
</ul>
<h4 id="节点"><a href="#节点" class="headerlink" title="节点"></a>节点</h4><ul>
<li>一个节点就是一个Elasticsearch的实例<ul>
<li>本质上就是一个JAVA进程</li>
<li>一台机器可以运行多个ES进程，但是生产环境一般建议一台机器上只运行一个</li>
</ul>
</li>
<li>每一个节点都有名字，通过配置文件配置或者启动的时候指定：-E node.name=node1</li>
<li>每个节点在启动之后会分配一个UID，保存在data目录下</li>
</ul>
<h5 id="Master-eligible-nodes-与-Master-Node"><a href="#Master-eligible-nodes-与-Master-Node" class="headerlink" title="Master-eligible nodes 与 Master Node"></a>Master-eligible nodes 与 Master Node</h5><ul>
<li>每个节点启动后，默认就是一个Master-eligible节点<ul>
<li>可以设置node.master: false禁止</li>
</ul>
</li>
<li>Master-eligible节点可以参加选主流程成为最后的Master节点</li>
<li>当第一个节点启动的时候，它会将自己选举成Master节点</li>
<li>每个节点上都保存了集群的状态，只有Master节点才能修改集群的状态信息<ul>
<li>集群状态（Cluster State），维护了一个集群中，必要的信息<ul>
<li>所有的节点信息</li>
<li>所有的索引和其相关的Mapping与Setting信息</li>
<li>分片路由信息</li>
</ul>
</li>
<li>任意节点都能修改信息会导致数据的不一致性</li>
</ul>
</li>
</ul>
<h5 id="Data-Node-与-Coordinating-Node"><a href="#Data-Node-与-Coordinating-Node" class="headerlink" title="Data Node 与 Coordinating Node"></a>Data Node 与 Coordinating Node</h5><ul>
<li>Data Node<ul>
<li>可以保存数据的节点，叫做Data Node。负责保存分片数据。在数据扩展上起到了至关重要的作用，例如在集群上无法存数据到时候，可以增加数据节点来解决这一问题。</li>
</ul>
</li>
<li>Coordinating Node<ul>
<li>负责接受Client的请求，将请求分发到合适到节点，最终把结果汇集到一起</li>
<li>每个节点默认都起到了Coordinating Node到职责</li>
</ul>
</li>
</ul>
<h5 id="其它类型的节点"><a href="#其它类型的节点" class="headerlink" title="其它类型的节点"></a>其它类型的节点</h5><ul>
<li>Hot &amp; Warm Node<ul>
<li>不同硬件配置的Data Node，用来实现Hot &amp; Warm架构，降低集群部署的成本</li>
</ul>
</li>
<li>Machine Learning Node<ul>
<li>负责跑机器学习的Job，比如用来做异常检测</li>
</ul>
</li>
<li>Tribe Node<ul>
<li>（5.3开始使用Cross Cluster Search）Tribe Node连接到不同到ES集群，并且支持将这些集群当成一个单独的集群处理。</li>
</ul>
</li>
</ul>
<h4 id="分片（Primary-Shard-amp-Replica-Shard）"><a href="#分片（Primary-Shard-amp-Replica-Shard）" class="headerlink" title="分片（Primary Shard &amp; Replica Shard）"></a>分片（Primary Shard &amp; Replica Shard）</h4><ul>
<li>主分片，用于解决数据水平扩展的问题。通过主分片，可以将数据分布到集群内的所有节点之上<ul>
<li>一个分片是一个运行的Lucene实例</li>
<li>主分片数在索引创建时指定，后续不允许修改，除非Reindex</li>
</ul>
</li>
<li>副本，用于解决数据高可用的问题，分片是主分片的拷贝<ul>
<li>副本分片数，可以动态调整</li>
<li>增加副本数，还可以在一定程度上提高服务的可用性（读取到吞吐）<br><img data-src="70b658a/AutoCapture_2020-07-11_103828.jpg" alt="分片示例"></li>
</ul>
</li>
</ul>
<h5 id="分片的设定"><a href="#分片的设定" class="headerlink" title="分片的设定"></a>分片的设定</h5><p>对于生产环境中的分片设定，需要提前做好容量规划，</p>
<ul>
<li>如果分片数量设置过小<ul>
<li>导致后续无法增加节点实现的水平扩展</li>
<li>单个分片的数据量太大，导致数据重新分配耗时</li>
</ul>
</li>
<li>分片数设置过大，7.0开始，默认主分片设置成1，解决了over-sharding的问题<ul>
<li>影响搜索结果的相关性打分，影响统计结果的准确性</li>
<li>单个节点上过多的分片，会导致资源浪费，同时也会影响性能</li>
</ul>
</li>
</ul>
<h4 id="文档的CRUD"><a href="#文档的CRUD" class="headerlink" title="文档的CRUD"></a>文档的CRUD</h4><p><strong>注：</strong>注意Index与Update之间的区别</p>
<ul>
<li>Type名，约定都用_doc</li>
<li>Create - 如果ID已经存在，会失败</li>
<li>Index - 如果ID不存在，创建新的文档。否则，先删除现有的文档，再创建新的文档，版本会增加</li>
<li>Update - 文档必须已经存在，更新只会对相应字段做增量修改<br><img data-src="70b658a/AutoCapture_2020-07-11_110449.jpg" alt="CRUD示例"></li>
</ul>
<h5 id="BULK-API"><a href="#BULK-API" class="headerlink" title="BULK API"></a>BULK API</h5><ul>
<li>支持在一次API调用中，对不同的索引进行操作</li>
<li>支持四种类型操作：CRUD</li>
<li>可以在URI中指定Index，也可以在请求的Payload中进行</li>
<li>操作中单条操作失败，并不会影响其他操作</li>
<li>返回结果包含了每一条操作执行的结果</li>
</ul>
<h5 id="批量读取mget与批量查询msearch"><a href="#批量读取mget与批量查询msearch" class="headerlink" title="批量读取mget与批量查询msearch"></a>批量读取mget与批量查询msearch</h5><p>批量读取：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET /_mget</span><br><span class="line">&#123;</span><br><span class="line">    &quot;docs&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;test&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;1&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_index&quot; : &quot;test&quot;,</span><br><span class="line">            &quot;_id&quot; : &quot;2&quot;</span><br><span class="line">            &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>批量查询：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST kibana_sample_data_ecommerce/_msearch</span><br><span class="line">&#123;&#125;</span><br><span class="line">&#123;&quot;query&quot; : &#123;&quot;match_all&quot; : &#123;&#125;&#125;, &quot;size&quot; : 1&#125;</span><br><span class="line">&#123;&quot;index&quot; : &quot;kibana_sample_data_flights&quot;&#125;</span><br><span class="line">&#123;&quot;query&quot; : &#123;&quot;match_all&quot; : &#123;&#125;&#125;, &quot;size&quot; : 2&#125;</span><br></pre></td></tr></table></figure>

<h3 id="12-倒排索引介绍"><a href="#12-倒排索引介绍" class="headerlink" title="(12)倒排索引介绍"></a>(12)倒排索引介绍</h3><p>在搜索引擎中，正排索引是一个文档ID到文档内容到关联，而倒排索引恰恰相反，就是一个单词到文档ID关联的关系。例如：<br><img data-src="70b658a/AutoCapture_2020-07-11_113536.jpg" alt="倒排索引与正排索引对比"></p>
<h4 id="倒排索引的核心组成"><a href="#倒排索引的核心组成" class="headerlink" title="倒排索引的核心组成"></a>倒排索引的核心组成</h4><p>倒排索引通常包含两个部分：</p>
<ul>
<li>单词词典（Term Dictionary），记录所有文档的单词，记录单词到倒排列表的关联关系<ul>
<li>单词词典一般比较大，可以通过B+树或者哈希链算法实现，以满足高性能的插入与查询</li>
</ul>
</li>
<li>倒排列表（Posting List），记录了单词对应的文档结构，由倒排索引项组成<ul>
<li>倒排索引项（Posting）<ul>
<li>文档ID</li>
<li>词频TF - 该单词在文档中出现的次数，用于相关性评分</li>
<li>位置（Position） - 单词在文档中分词的位置，用于语句搜索（phrase query）</li>
<li>偏移（Offset） - 记录单词的开始和结束位置，实现高亮显示。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>在ES中的倒排索引：<br>JSON文档中的每个字段，都有自己的倒排索引，可以指定对某些字段不做索引：</p>
<ul>
<li>优点：节省存储空间</li>
<li>缺点：字段无法被搜索</li>
</ul>
<h3 id="13-通过Analyzer进行分词"><a href="#13-通过Analyzer进行分词" class="headerlink" title="(13)通过Analyzer进行分词"></a>(13)通过Analyzer进行分词</h3><h4 id="Analysis-与-Analyzer"><a href="#Analysis-与-Analyzer" class="headerlink" title="Analysis 与 Analyzer"></a>Analysis 与 Analyzer</h4><ul>
<li>Analysis - 文本分析是把全文本转化一系列单词（term / token）的过程，也叫分词</li>
<li>Analysis是通过Analyzer（分词器）来实现的<ul>
<li>可以通过ES内置的分词器，或者按需定制化分词器</li>
</ul>
</li>
<li>除了在数据写入时转换词条，匹配Query语句时候也需要使用相同的分词器对查询语句进行分析</li>
</ul>
<h5 id="Analyzer的组成"><a href="#Analyzer的组成" class="headerlink" title="Analyzer的组成"></a>Analyzer的组成</h5><p>分词器是专门处理分词的组件，Analyzer由三部分组成</p>
<ul>
<li>Character Filters（针对原始文本处理，例如去除html标签）</li>
<li>Tokenizer（按照规则切分单词）</li>
<li>Token Filter（将切分的单词进行加工，小写，删除Stopwords，增加同义词）<br>处理流程示例如下图所示：<br><img data-src="70b658a/AutoCapture_2020-07-11_115912.jpg" alt="分词处理流程示例"></li>
</ul>
<h3 id="14-Search-API概览"><a href="#14-Search-API概览" class="headerlink" title="(14)Search API概览"></a>(14)Search API概览</h3><p>指定查询的索引<br><img data-src="70b658a/AutoCapture_2020-07-11_133509.jpg" alt="指定查询的索引"><br>查询响应：</p>
<ul>
<li>took 花费的时间</li>
<li>total 符合条件的总文档数</li>
<li>hits 结果集，默认前10个文档<ul>
<li>_index: 索引名</li>
<li>_id: 文档的ID</li>
<li>_score: 相关度评分</li>
<li>_source: 文档原始信息</li>
</ul>
</li>
</ul>
<h4 id="搜索的相关性Relevance"><a href="#搜索的相关性Relevance" class="headerlink" title="搜索的相关性Relevance"></a>搜索的相关性Relevance</h4><ul>
<li>搜索是用户和搜索引擎的对话</li>
<li>用户关心的是搜索结果的相关性<ul>
<li>是否可以找到相关的内容</li>
<li>有多少不相关的内容被返回了</li>
<li>文档的打分是否合理</li>
<li>结合业务需求，平衡结果排名</li>
</ul>
</li>
</ul>
<h4 id="衡量相关性"><a href="#衡量相关性" class="headerlink" title="衡量相关性"></a>衡量相关性</h4><p>Information Retrieval</p>
<ul>
<li>Precision(查准率) - 尽可能返回较少的无关文档</li>
<li>Recall(查全率) - 尽量返回较多的相关文档</li>
<li>Ranking - 是否能够按照相关度进行排序</li>
</ul>
<h3 id="15-URI-Search详解"><a href="#15-URI-Search详解" class="headerlink" title="(15)URI Search详解"></a>(15)URI Search详解</h3><p>顾名思义，通过URI query实现搜索，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /movies/_search?q=2012&amp;df=title&amp;sort=year:desc&amp;from=0&amp;size=10&amp;timeout=1s</span><br><span class="line">&#123;</span><br><span class="line">    &quot;profile&quot; : true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述命令中：</p>
<ul>
<li>q指定查询语句，使用Query String Syntax</li>
<li>df默认字段，不指定时，会对所有字段进行查询</li>
<li>Sort排序 / from和size用于分页</li>
<li>Profile可以查看查询是如何被执行的</li>
</ul>
<h4 id="Query-String-Syntax"><a href="#Query-String-Syntax" class="headerlink" title="Query String Syntax"></a>Query String Syntax</h4><ul>
<li>指定字段 v.s 泛查询<ul>
<li>q = title:2012 / q=2012</li>
</ul>
</li>
<li>Term v.s Phrase<ul>
<li>Beautiful Mind 等效于 Beautiful OR Mind</li>
<li>“Beautiful Mind”，等效于Beautiful AND Mind。 Phrase查询，还要求前后顺序保持一致。</li>
</ul>
</li>
<li>分组与引号<ul>
<li>Term Query: title:(Beautiful AND Mind)</li>
<li>Phrase Query: title=”Beautiful Mind”</li>
</ul>
</li>
<li>布尔操作<ul>
<li>AND | OR | NOT 或者 &amp;&amp; | || | !<ul>
<li>所有布尔操作符必须大写</li>
<li>例如：title:(matrix NOT reloaded)</li>
</ul>
</li>
</ul>
</li>
<li>分组<ul>
<li><ul>
<li>表示 must</li>
</ul>
</li>
<li><ul>
<li>表示 must not</li>
</ul>
</li>
<li>title:(+matrix -reloaded)</li>
</ul>
</li>
<li>范围查询<ul>
<li>区间表示:[] 闭区间, {}开区间<ul>
<li>year:{2019 TO 2018}</li>
<li>year:[* TO 2018]</li>
</ul>
</li>
</ul>
</li>
<li>算数符号<ul>
<li>year:&gt;2010</li>
<li>year:(&gt;2010 &amp;&amp; &lt;= 2018)</li>
<li>year:(+&gt;2010 +&lt;=2018)</li>
</ul>
</li>
<li>通配符查询（通配符查询效率低，占用内存大，不建议使用。特别放在最前面）<ul>
<li>？表示1个字符，*代表0或者多个字符<ul>
<li>title:mi?d</li>
<li>title:be*</li>
</ul>
</li>
</ul>
</li>
<li>正则表达式<ul>
<li>title:[bt]oy</li>
</ul>
</li>
<li>模糊匹配与近似查询<ul>
<li>title:befutifl~1</li>
<li>title:”Loard Rings”<del>2 // 近似匹配，如果不加</del>2则是需要强匹配的Phrase Query </li>
</ul>
</li>
</ul>
<p>查询示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// TermQuery示例</span><br><span class="line">GET /movies/_search?q=title:(Beautiful AND Mind)</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// bool查询示例</span><br><span class="line">GET /movies/_search?q=title:(Beautiful NOT Mind)</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /movies/_search?q=title:(Beautiful %2BMind)</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /movies/_search?q=title:be*</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /movies/_search?q=title:&quot;lord rings&quot;~2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="16-Request-Body-与-Query-DSL简介"><a href="#16-Request-Body-与-Query-DSL简介" class="headerlink" title="(16)Request Body 与 Query DSL简介"></a>(16)Request Body 与 Query DSL简介</h3><p>总体上，建议使用Request Body查询</p>
<ul>
<li>将查询语句通过HTTP Request Body发送给ES</li>
<li>Query DSL<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /movies,404_idx/_search?ignore_unavailable=true</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="脚本字段"><a href="#脚本字段" class="headerlink" title="脚本字段"></a>脚本字段</h4><p>在Request Body中使用painless字段，组合查询出新的字段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;script_fields&quot;: &#123;</span><br><span class="line">    &quot;new_field&quot;: &#123;</span><br><span class="line">      &quot;script&quot;: &#123;</span><br><span class="line">        &quot;lang&quot;: &quot;painless&quot;,</span><br><span class="line">        &quot;source&quot;: &quot;doc[&#x27;order_date&#x27;].value+&#x27;_hello&#x27;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;from&quot; : 10,</span><br><span class="line">  &quot;size&quot;: 5,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="17-Query-String-与-Simple-Query-String查询"><a href="#17-Query-String-与-Simple-Query-String查询" class="headerlink" title="(17)Query String 与 Simple Query String查询"></a>(17)Query String 与 Simple Query String查询</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">PUT /users/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;Ruan Yiming&quot;,</span><br><span class="line">  &quot;about&quot;:&quot;java, golang, node, swift, elasticsearch&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /users/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;Li Yiming&quot;,</span><br><span class="line">  &quot;about&quot;:&quot;Hadoop&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST users/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;</span><br><span class="line">      &quot;default_field&quot;: &quot;name&quot;,</span><br><span class="line">      &quot;query&quot;: &quot;Ruan AND Yiming&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST users/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;</span><br><span class="line">      &quot;fields&quot;:[&quot;name&quot;,&quot;about&quot;],</span><br><span class="line">      &quot;query&quot;: &quot;(Ruan AND Yiming) OR (Java AND Elasticsearch)&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Simple Query 默认的operator是 Or</span><br><span class="line">POST users/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;simple_query_string&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;Ruan AND Yiming&quot;,</span><br><span class="line">      &quot;fields&quot;: [&quot;name&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST users/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;simple_query_string&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;Ruan Yiming&quot;,</span><br><span class="line">      &quot;fields&quot;: [&quot;name&quot;],</span><br><span class="line">      &quot;default_operator&quot;: &quot;AND&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET /movies/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;profile&quot;: true,</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;query_string&quot;:&#123;</span><br><span class="line">            &quot;default_field&quot;: &quot;title&quot;,</span><br><span class="line">            &quot;query&quot;: &quot;Beafiful AND Mind&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 多fields</span><br><span class="line">GET /movies/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;profile&quot;: true,</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;query_string&quot;:&#123;</span><br><span class="line">            &quot;fields&quot;:[</span><br><span class="line">                &quot;title&quot;,</span><br><span class="line">                &quot;year&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;query&quot;: &quot;2012&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET /movies/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;profile&quot;:true,</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;simple_query_string&quot;:&#123;</span><br><span class="line">            &quot;query&quot;:&quot;Beautiful +mind&quot;,</span><br><span class="line">            &quot;fields&quot;:[&quot;title&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="18-Dynamic-Mapping和常见字段类型"><a href="#18-Dynamic-Mapping和常见字段类型" class="headerlink" title="(18)Dynamic Mapping和常见字段类型"></a>(18)Dynamic Mapping和常见字段类型</h3><ul>
<li>Mapping类似数据库中的schema定义，作用如下：<ul>
<li>定义索引中的字段名称</li>
<li>定义字段的数据类型，例如字符串，数字，布尔等等</li>
<li>字段，倒排索引的相关配置（Analyzed or Not Analyzed, Analyzer）</li>
</ul>
</li>
<li>Mapping会把JSON稳定映射成为Lucene所需要的扁平格式</li>
<li>一个Mapping属于一个索引的Type<ul>
<li><p>每个文档都属于一个Type</p>
</li>
<li><p>一个Type有一个Mapping定义</p>
</li>
<li><p>7.0开始，不需要在Mapping定义中指定type信息</p>
<h4 id="字段的数据类型"><a href="#字段的数据类型" class="headerlink" title="字段的数据类型"></a>字段的数据类型</h4></li>
</ul>
</li>
<li>简单类型<ul>
<li>Text / Keyword</li>
<li>Date</li>
<li>Integer / Floating</li>
<li>Boolean</li>
<li>IPv4 &amp; IPv6</li>
</ul>
</li>
<li>复杂类型 - 对象和嵌套对象<ul>
<li>对象类型 / 嵌套类型</li>
</ul>
</li>
<li>特殊类型 <ul>
<li>geo_point &amp; geo_shape / percolator</li>
</ul>
</li>
</ul>
<h4 id="什么是Dynamic-Mapping"><a href="#什么是Dynamic-Mapping" class="headerlink" title="什么是Dynamic Mapping"></a>什么是Dynamic Mapping</h4><ul>
<li>在写入文档的时候，如果索引不存在，会自动创建索引</li>
<li>Dynamic Mapping的机制，使得我们无需手动定义Mapping。ES会自动根据稳定信息，推算出字段的类型</li>
<li>但是有时候会推算的不对，例如地理位置信息</li>
<li>当类型如果设置不对时，会导致一些功能无法正常运行，例如Range查询</li>
</ul>
<h5 id="类型的自动识别"><a href="#类型的自动识别" class="headerlink" title="类型的自动识别"></a>类型的自动识别</h5><p><img data-src="70b658a/AutoCapture_2020-07-11_173010.jpg" alt="ES动态Mapping中类型自动匹配关系"></p>
<h5 id="能否改mapping的字段类型"><a href="#能否改mapping的字段类型" class="headerlink" title="能否改mapping的字段类型"></a>能否改mapping的字段类型</h5><p>分两种情况：</p>
<ul>
<li>新增字段：<ul>
<li>Dynamic设置为true时，一旦有新增字段的文档写入，mapping也同时被更新</li>
<li>Dynamic设置为false时，mapping不会被更新，心中字段的数据无法被搜索</li>
<li>Dynamic</li>
</ul>
</li>
<li>如果希望改变字段类型，必须ReindexAPI，重建索引<br>因为：</li>
<li>如果修改了字段的数据类型，会导致已被索引的属性无法被搜索</li>
<li>但是如果是新增的字段，就不会有这样的影响</li>
</ul>
<h5 id="自定义Mapping的一些建议"><a href="#自定义Mapping的一些建议" class="headerlink" title="自定义Mapping的一些建议"></a>自定义Mapping的一些建议</h5><ul>
<li>可以参考API手册，纯手写</li>
<li>为了减少输入工作量，减少出错的概率，可以依照以下步骤<ul>
<li>创建一个临时的index，写入一些样本数据</li>
<li>通过访问Mapping API获得该临时文件的动态Mapping定义</li>
<li>修改后用，使用新的配置来创建索引</li>
<li>删除临时索引</li>
</ul>
</li>
</ul>
<h5 id="index优化建议"><a href="#index优化建议" class="headerlink" title="index优化建议"></a>index优化建议</h5><ul>
<li>四种不同级别的Index Options配置，可以控制倒排索引记录的内容<ul>
<li>docs - 记录doc id</li>
<li>freqs - 记录doc id和term frequencies</li>
<li>positions - 记录doc id / term frequencies / term position</li>
<li>offsets - 记录doc id / term frequencies / term position / character offects</li>
</ul>
</li>
<li>Text类型默认记录positions，其它默认为docs</li>
<li>记录内容越多，占用存储空间越大</li>
<li>null_value的属性使用：如果需要搜索，但是可能没有有效值，可以设置该属性为null以实现对null值的索引</li>
</ul>
<h3 id="20-多字段类型"><a href="#20-多字段类型" class="headerlink" title="(20)多字段类型"></a>(20)多字段类型</h3><p>多字段特性，举例：</p>
<ul>
<li>厂商的名字实现精确匹配<ul>
<li>增加一个keyword字段</li>
</ul>
</li>
<li>使用不同的analyzer<ul>
<li>不同语言</li>
<li>pinyin字段的搜索</li>
<li>还支持为搜索和索引指定不同的analyzer<br>例如：<br><img data-src="70b658a/AutoCapture_2020-07-11_213211.jpg" alt="多字段Mapping示例"></li>
</ul>
</li>
</ul>
<h4 id="精确值-Exact-Values-与-全文本-Full-text"><a href="#精确值-Exact-Values-与-全文本-Full-text" class="headerlink" title="精确值(Exact Values) 与 全文本(Full text)"></a>精确值(Exact Values) 与 全文本(Full text)</h4><p>精确值：包括数字、日期、具体一个字符串（例如“Apple Store”）<br>    + ES中的keyword<br>    + 与全文本中最大的区别就是：精确值不需要被做分词的处理<br>全文本：非结构化的文本数据<br>    + ES中的text</p>
<h4 id="自定义分词"><a href="#自定义分词" class="headerlink" title="自定义分词"></a>自定义分词</h4><p>当自带的分词器无法满足时，可以自定义分词器，通过组合不同的组件来实现：</p>
<ul>
<li>Character Filters</li>
<li>Tokenizer</li>
<li>Token Filter<h5 id="Character-Filters"><a href="#Character-Filters" class="headerlink" title="Character Filters"></a>Character Filters</h5>在Tokenizer处理之前对文本进行特殊的处理，例如增加删除及替换字符。可以配置多个Character Filters。最终会影响Tokenizer的position和offset信息。<br>一些自带的Character Filters</li>
<li>HTML strip - 去除HTML标签，例如在网络爬虫数据之后，就可以把一些不必要的标签给过滤了</li>
<li>Mapping - 字符串替换</li>
<li>Pattern replace - 正则匹配替换<h5 id="Tokenizer"><a href="#Tokenizer" class="headerlink" title="Tokenizer"></a>Tokenizer</h5>将原始的文本按照一定的规则，切为分词（term or token）<br>ES内置的Tokenizers：</li>
<li>whitespace：空白符</li>
<li>standard：</li>
<li>uax_url_email</li>
<li>pattern：正则</li>
<li>keyword：不做任何处理，直接把输入的字符串当做一个keyword输出</li>
<li>path hierarchy<br>也可以用Java插件开发，实现自己的Tokenizer<h5 id="Token-Filter"><a href="#Token-Filter" class="headerlink" title="Token Filter"></a>Token Filter</h5>将Tokenizer输出的单词（term），进行增加、修改、删除<br>自带的Token Filters：</li>
<li>Lowercase</li>
<li>stop：过滤停用词</li>
<li>synonym（添加近义词）<h5 id="设置一个Custom-Analyzer"><a href="#设置一个Custom-Analyzer" class="headerlink" title="设置一个Custom Analyzer"></a>设置一个Custom Analyzer</h5>例如：<br><img data-src="70b658a/AutoCapture_2020-07-11_215242.jpg" alt="自定义分词器实现"></li>
</ul>
<h4 id="课程示例"><a href="#课程示例" class="headerlink" title="课程示例"></a>课程示例</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">// 过滤html标签</span><br><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;:&quot;keyword&quot;,</span><br><span class="line">  &quot;char_filter&quot;:[&quot;html_strip&quot;],</span><br><span class="line">  &quot;text&quot;: &quot;&lt;b&gt;hello world&lt;/b&gt;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 利用char_filter替换符号</span><br><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;standard&quot;,</span><br><span class="line">  &quot;char_filter&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;type&quot; : &quot;mapping&quot;,</span><br><span class="line">        &quot;mappings&quot; : [ &quot;- =&gt; _&quot;]</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">  &quot;text&quot;: &quot;123-456, I-test! test-990 650-555-1234&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 利用char filter替换表情符号</span><br><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;standard&quot;,</span><br><span class="line">  &quot;char_filter&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;type&quot; : &quot;mapping&quot;,</span><br><span class="line">        &quot;mappings&quot; : [ &quot;:) =&gt; happy&quot;, &quot;:( =&gt; sad&quot;]</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;text&quot;: [&quot;I am felling :)&quot;, &quot;Feeling :( today&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 通过自定义正则表达式实现替换</span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;standard&quot;,</span><br><span class="line">  &quot;char_filter&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;type&quot; : &quot;pattern_replace&quot;,</span><br><span class="line">        &quot;pattern&quot; : &quot;http://(.*)&quot;,</span><br><span class="line">        &quot;replacement&quot; : &quot;$1&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;text&quot; : &quot;http://www.elastic.co&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 利用tokenizer切分，切分后按照一级级目录切分后的结果</span><br><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;:&quot;path_hierarchy&quot;,</span><br><span class="line">  &quot;text&quot;:&quot;/user/ymruan/a/b/c/d/e&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// whitespace and stop</span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;whitespace&quot;,</span><br><span class="line">  &quot;filter&quot;: [&quot;stop&quot;,&quot;snowball&quot;],</span><br><span class="line">  &quot;text&quot;: [&quot;The gilrs in China are playing this game!&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//remove 加入lowercase后，The被当成 stopword删除</span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;whitespace&quot;,</span><br><span class="line">  &quot;filter&quot;: [&quot;lowercase&quot;,&quot;stop&quot;,&quot;snowball&quot;],</span><br><span class="line">  &quot;text&quot;: [&quot;The gilrs in China are playing this game!&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="自定义分词索引示例"><a href="#自定义分词索引示例" class="headerlink" title="自定义分词索引示例"></a>自定义分词索引示例</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">// 自定义分词器索引</span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;my_custom_analyzer&quot; : &#123;</span><br><span class="line">          &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">          &quot;char_filter&quot;: [</span><br><span class="line">            &quot;emoticons&quot;</span><br><span class="line">          ],</span><br><span class="line">          &quot;tokenizer&quot;: &quot;punctuation&quot;,</span><br><span class="line">          &quot;filter&quot;: [</span><br><span class="line">            &quot;lowercase&quot;,</span><br><span class="line">            &quot;english_stop&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;tokenizer&quot;: &#123;</span><br><span class="line">        &quot;punctuation&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;pattern&quot;,</span><br><span class="line">          &quot;pattern&quot;: &quot;[ .,!? ]&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;char_filter&quot;: &#123;</span><br><span class="line">        &quot;emoticons&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;mapping&quot;,</span><br><span class="line">          &quot;mappings&quot;: [</span><br><span class="line">            &quot;:) =&gt; _happy_&quot;,</span><br><span class="line">            &quot;:( =&gt; _sad_&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;english_stop&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;stop&quot;,</span><br><span class="line">          &quot;stopwords&quot;: &quot;_english_&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST my_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;my_custom_analyzer&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;I&#x27;m a :) person, and you?&quot;</span><br><span class="line">&#125;</span><br><span class="line">// 输出结果</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;i&#x27;m&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 3,</span><br><span class="line">      &quot;type&quot; : &quot;word&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;_happy_&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 6,</span><br><span class="line">      &quot;end_offset&quot; : 8,</span><br><span class="line">      &quot;type&quot; : &quot;word&quot;,</span><br><span class="line">      &quot;position&quot; : 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;person&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 9,</span><br><span class="line">      &quot;end_offset&quot; : 15,</span><br><span class="line">      &quot;type&quot; : &quot;word&quot;,</span><br><span class="line">      &quot;position&quot; : 3</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;you&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 21,</span><br><span class="line">      &quot;end_offset&quot; : 24,</span><br><span class="line">      &quot;type&quot; : &quot;word&quot;,</span><br><span class="line">      &quot;position&quot; : 5</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="21-Index-Template和Dynamic-Template"><a href="#21-Index-Template和Dynamic-Template" class="headerlink" title="(21)Index Template和Dynamic Template"></a>(21)Index Template和Dynamic Template</h3><h4 id="什么是Index-Template"><a href="#什么是Index-Template" class="headerlink" title="什么是Index Template"></a>什么是Index Template</h4><p>Index Templates：帮助按照一定的模板自动设定Mappings和Settings，并按照一定的规则，自动匹配到新创建的索引之上。</p>
<ul>
<li>模板仅在一个索引被新创建时，才会产生作用。修改模板不会影响已创建的索引</li>
<li>可以设定多个索引模板，这些设置会被“merge”在一起</li>
<li>可以指定“order”的数值，控制“merging”的过程<br>两个自动创建的示例：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">PUT _template/template_default</span><br><span class="line">&#123;</span><br><span class="line">  &quot;index_patterns&quot;: [&quot;*&quot;],</span><br><span class="line">  &quot;order&quot; : 0,</span><br><span class="line">  &quot;version&quot;: 1,</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 1,</span><br><span class="line">    &quot;number_of_replicas&quot;:1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT /_template/template_test</span><br><span class="line">&#123;</span><br><span class="line">    &quot;index_patterns&quot; : [&quot;test*&quot;],</span><br><span class="line">    &quot;order&quot; : 1,</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">        &quot;number_of_shards&quot;: 1,</span><br><span class="line">        &quot;number_of_replicas&quot; : 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">        &quot;date_detection&quot;: false,</span><br><span class="line">        &quot;numeric_detection&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Index-Template的工作方式"><a href="#Index-Template的工作方式" class="headerlink" title="Index Template的工作方式"></a>Index Template的工作方式</h4>当一个索引被新创建时</li>
<li>应用ES默认的settings和mappings</li>
<li>应用order数值低的Index Template中的设定</li>
<li>应用order高的Index Template中的设定，之前的设定会被覆盖</li>
<li>应用创建索引时，用户指定的Settings和Mappings，并覆盖之前模板中的设定</li>
</ul>
<h4 id="什么是Dynamic-Template"><a href="#什么是Dynamic-Template" class="headerlink" title="什么是Dynamic Template"></a>什么是Dynamic Template</h4><p>根据ES识别的数据类型，结合字段名称，来动态设定字段类型，例如：</p>
<ul>
<li>所有的字符串类型都设定成keyword，或者关闭keyword字段</li>
<li>is开头的字段都设置成boolean</li>
<li>long开头的都设置成long类型</li>
</ul>
<h5 id="课程代码示例"><a href="#课程代码示例" class="headerlink" title="课程代码示例"></a>课程代码示例</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">#Dynaminc Mapping 根据类型和字段名</span><br><span class="line">DELETE my_index</span><br><span class="line"></span><br><span class="line">PUT my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;firstName&quot;:&quot;Ruan&quot;,</span><br><span class="line">  &quot;isVIP&quot;:&quot;true&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET my_index/_mapping</span><br><span class="line">DELETE my_index</span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;dynamic_templates&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">        &quot;strings_as_boolean&quot;: &#123;</span><br><span class="line">          &quot;match_mapping_type&quot;:   &quot;string&quot;,</span><br><span class="line">          &quot;match&quot;:&quot;is*&quot;,</span><br><span class="line">          &quot;mapping&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;boolean&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;strings_as_keywords&quot;: &#123;</span><br><span class="line">          &quot;match_mapping_type&quot;:   &quot;string&quot;,</span><br><span class="line">          &quot;mapping&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DELETE my_index</span><br><span class="line"># 结合路径</span><br><span class="line">## Dynamic Template是定义在某个索引的Mapping中的</span><br><span class="line">## Tempalte有一个名称</span><br><span class="line">## 匹配规则是一个数组</span><br><span class="line">## 为匹配到的字段设置Mapping</span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;dynamic_templates&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;full_name&quot;: &#123;</span><br><span class="line">          &quot;path_match&quot;:   &quot;name.*&quot;,</span><br><span class="line">          &quot;path_unmatch&quot;: &quot;*.middle&quot;,</span><br><span class="line">          &quot;mapping&quot;: &#123;</span><br><span class="line">            &quot;type&quot;:       &quot;text&quot;,</span><br><span class="line">            &quot;copy_to&quot;:    &quot;full_name&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="相关阅读"><a href="#相关阅读" class="headerlink" title="相关阅读"></a>相关阅读</h4><ul>
<li>Index Templates <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/indices-templates.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/indices-templates.html</a></li>
<li>Dynamic Template <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/dynamic-mapping.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/dynamic-mapping.html</a></li>
</ul>
<h3 id="22-ES聚合分析简介"><a href="#22-ES聚合分析简介" class="headerlink" title="(22)ES聚合分析简介"></a>(22)ES聚合分析简介</h3><h4 id="什么是聚合-Aggregation"><a href="#什么是聚合-Aggregation" class="headerlink" title="什么是聚合(Aggregation)"></a>什么是聚合(Aggregation)</h4><ul>
<li>ES除搜索以外，提供的针对ES数据进行统计分析的功能<ul>
<li>实时性高</li>
<li>Hadoop有时候统计数据可能需要一天的时间(T+1)</li>
</ul>
</li>
<li>通过聚合，我们会得到一个数据的概览，是分析和总结全套的数据，而不是寻找单个稳定<ul>
<li>比如：沙尖咀和香港岛的客房数量</li>
<li>不同的价格区间，可预订的经济型酒店和五星级酒店的数量</li>
</ul>
</li>
<li>高性能，只需要一条语句，就可以从ES中得到分析结果<ul>
<li>无需再客户端自己实现分析的逻辑<h4 id="聚合的分类"><a href="#聚合的分类" class="headerlink" title="聚合的分类"></a>聚合的分类</h4></li>
</ul>
</li>
<li>Bucket Aggregation - 一些列满足特定条件的文档的集合，即数据桶</li>
<li>Metric Aggregation - 一些数学运算，可以对文档字段进行统计分析</li>
<li>Pipeline Aggregation - 对其他的聚合结果进行二次聚合</li>
<li>Matrix Aggregation - 支持对多个字段的操作并提供一个结果矩阵<h4 id="Bucket-amp-Metric"><a href="#Bucket-amp-Metric" class="headerlink" title="Bucket &amp; Metric"></a>Bucket &amp; Metric</h4>Metric类比于SQL中的一系列统计方法<br>Bucket类比于SQL中的一系列的Group<br>Bucket示意图：<br><img data-src="70b658a/AutoCapture_2020-07-11_232645.jpg" alt="Bucket示意图"><br>Metric：</li>
<li>Metric会基于数据集计算结果，除了支持在字段上进行计算，同样也支持在脚本（painless script）产生的结果之上进行计算</li>
<li>大多数Metric是数学计算，仅输出一个值<ul>
<li>min / max / sum / avg / cardinality</li>
</ul>
</li>
<li>部分metric支持输出多个数值<ul>
<li>stats / percentiles / percentile_ranks<h5 id="一个Bucket的例子"><a href="#一个Bucket的例子" class="headerlink" title="一个Bucket的例子"></a>一个Bucket的例子</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 查看航班目的地的统计信息</span><br><span class="line">GET kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;flight_dest&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;DestCountry&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
输出结果<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"># 输出结果</span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 31,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 10000,</span><br><span class="line">      &quot;relation&quot; : &quot;gte&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : null,</span><br><span class="line">    &quot;hits&quot; : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggregations&quot; : &#123;</span><br><span class="line">    &quot;flight_dest&quot; : &#123;</span><br><span class="line">      &quot;doc_count_error_upper_bound&quot; : 0,</span><br><span class="line">      &quot;sum_other_doc_count&quot; : 3187,</span><br><span class="line">      &quot;buckets&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;IT&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 2371</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;US&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 1987</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;CN&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 1096</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;CA&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 944</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;JP&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 774</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;RU&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 739</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;CH&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 691</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;GB&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 449</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;AU&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 416</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;PL&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 405</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h5 id="一个Metrics示例"><a href="#一个Metrics示例" class="headerlink" title="一个Metrics示例"></a>一个Metrics示例</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#查看航班目的地的统计信息，增加平均，最高最低价格</span><br><span class="line">GET kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot;: 0,</span><br><span class="line">    &quot;aggs&quot;:&#123;</span><br><span class="line">        &quot;flight_dest&quot;:&#123;</span><br><span class="line">            &quot;terms&quot;:&#123;</span><br><span class="line">                &quot;field&quot;:&quot;DestCountry&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;aggs&quot;:&#123;</span><br><span class="line">                &quot;avg_price&quot;:&#123;</span><br><span class="line">                    &quot;avg&quot;:&#123;</span><br><span class="line">                        &quot;field&quot;:&quot;AvgTicketPrice&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;max_price&quot;:&#123;</span><br><span class="line">                    &quot;max&quot;:&#123;</span><br><span class="line">                        &quot;field&quot;:&quot;AvgTicketPrice&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;min_price&quot;:&#123;</span><br><span class="line">                    &quot;min&quot;:&#123;</span><br><span class="line">                        &quot;field&quot;:&quot;AvgTicketPrice&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 43,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 10000,</span><br><span class="line">      &quot;relation&quot; : &quot;gte&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : null,</span><br><span class="line">    &quot;hits&quot; : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggregations&quot; : &#123;</span><br><span class="line">    &quot;flight_dest&quot; : &#123;</span><br><span class="line">      &quot;doc_count_error_upper_bound&quot; : 0,</span><br><span class="line">      &quot;sum_other_doc_count&quot; : 3187,</span><br><span class="line">      &quot;buckets&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;IT&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 2371,</span><br><span class="line">          &quot;max_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 1195.3363037109375</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;min_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 100.57646942138672</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;avg_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 586.9627099618385</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;US&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 1987,</span><br><span class="line">          &quot;max_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 1199.72900390625</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;min_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 100.14596557617188</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;avg_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 595.7743908825026</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;CN&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 1096,</span><br><span class="line">          &quot;max_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 1198.4901123046875</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;min_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 102.90382385253906</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;avg_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 640.7101617033464</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;CA&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 944,</span><br><span class="line">          &quot;max_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 1198.8525390625</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;min_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 100.5572509765625</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;avg_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 648.7471090413757</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;JP&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 774,</span><br><span class="line">          &quot;max_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 1199.4913330078125</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;min_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 103.97209930419922</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;avg_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 650.9203447346847</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;RU&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 739,</span><br><span class="line">          &quot;max_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 1196.7423095703125</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;min_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 101.0040054321289</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;avg_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 662.9949632162009</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;CH&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 691,</span><br><span class="line">          &quot;max_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 1196.496826171875</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;min_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 101.3473129272461</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;avg_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 575.1067587028537</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;GB&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 449,</span><br><span class="line">          &quot;max_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 1197.78564453125</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;min_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 111.34574890136719</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;avg_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 650.5326856005696</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;AU&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 416,</span><br><span class="line">          &quot;max_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 1197.6326904296875</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;min_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 102.2943115234375</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;avg_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 669.5588319668403</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;PL&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 405,</span><br><span class="line">          &quot;max_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 1185.43701171875</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;min_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 104.28328704833984</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;avg_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 662.4497233072917</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="24-基于词项-Term-和基于全文的搜索"><a href="#24-基于词项-Term-和基于全文的搜索" class="headerlink" title="(24)基于词项(Term)和基于全文的搜索"></a>(24)基于词项(Term)和基于全文的搜索</h3><h4 id="基于Term的查询"><a href="#基于Term的查询" class="headerlink" title="基于Term的查询"></a>基于Term的查询</h4><ul>
<li>Term的重要性<ul>
<li><strong>Term是表达语义的最小单位。</strong>搜索和利用统计语言模型进行自然语言处理都需要处理Term。</li>
</ul>
</li>
<li>特点<ul>
<li>Term Level Query:<ul>
<li>Term Query</li>
<li>Range Query</li>
<li>Exists Query</li>
<li>Prefix Query</li>
<li>Wildcard Query</li>
</ul>
</li>
<li>在ES中，Term查询，对输入 <strong>不做分词</strong> 会将输入作为一个整体，在倒排索引中查找准确的词项，并且使用相关度算分公式为每个包含该词项的文档进行 <strong>相关度算分</strong><ul>
<li>所以，在Term查询中，如果需要精确匹配，在Mapping的设置中，可以将这个字段设置成keyword字段，查询的时候指定keyword就可以精确匹配</li>
</ul>
</li>
<li>可以通过Constant Score将查询 <strong>转换成一个Filtering，避免算法，并利用缓存，提高性能</strong></li>
</ul>
</li>
</ul>
<h5 id="Term查询示例"><a href="#Term查询示例" class="headerlink" title="Term查询示例"></a>Term查询示例</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">DELETE products</span><br><span class="line">PUT products</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /products/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class="line">&#123; &quot;productID&quot; : &quot;XHDK-A-1293-#fJ3&quot;,&quot;desc&quot;:&quot;iPhone&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class="line">&#123; &quot;productID&quot; : &quot;KDKE-B-9947-#kL5&quot;,&quot;desc&quot;:&quot;iPad&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3 &#125;&#125;</span><br><span class="line">&#123; &quot;productID&quot; : &quot;JODL-X-1937-#pV7&quot;,&quot;desc&quot;:&quot;MBP&quot; &#125;</span><br><span class="line"></span><br><span class="line">GET /products</span><br><span class="line"></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;desc&quot;: &#123;</span><br><span class="line">        # 这里搜索iPhone并不会得到结果，因为term查询默认不会对输入进行分词处理，也就是这里搜索的desc内容是iPhone</span><br><span class="line">        # 但是ES在做数据索引的时候，默认会对text类型的数据进行分词处理，所以实际应该是iphone</span><br><span class="line">        //&quot;value&quot;: &quot;iPhone&quot;</span><br><span class="line">        &quot;value&quot;:&quot;iphone&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;productID&quot;: &#123;</span><br><span class="line">        # 这里搜索是匹配不到的，因为同样会被做分词处理</span><br><span class="line">        &quot;value&quot;: &quot;XHDK-A-1293-#fJ3&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 可以通过_analyze分析，看一下默认标准分词处理</span><br><span class="line">POST /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;standard&quot;,</span><br><span class="line">  &quot;text&quot;: [&quot;XHDK-A-1293-#fJ3&quot;]</span><br><span class="line">&#125;</span><br><span class="line"># 输出结果，可以看出默认标准分词之后，所有的字母都变成了小写同时，符号-都没有了</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;xhdk&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 4,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;a&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 5,</span><br><span class="line">      &quot;end_offset&quot; : 6,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;1293&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 7,</span><br><span class="line">      &quot;end_offset&quot; : 11,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;NUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;fj3&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 13,</span><br><span class="line">      &quot;end_offset&quot; : 16,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 3</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 针对keyword查询则能严格查询到指定的结果值</span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  //&quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;productID.keyword&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;XHDK-A-1293-#fJ3&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="复合查询-Constant-Score-转为Filter"><a href="#复合查询-Constant-Score-转为Filter" class="headerlink" title="复合查询 - Constant Score 转为Filter"></a>复合查询 - Constant Score 转为Filter</h4><ul>
<li>将Query转成Filter，忽略TF-IDF计算，避免相关性算分的开销</li>
<li>Filter可以有效利用缓存<br>例如上述示例中：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># </span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;term&quot;: &#123;</span><br><span class="line">          &quot;productID.keyword&quot;: &quot;XHDK-A-1293-#fJ3&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="基于全文的查询"><a href="#基于全文的查询" class="headerlink" title="基于全文的查询"></a>基于全文的查询</h4><ul>
<li>基于全文本查找<ul>
<li>Match Query</li>
<li>Match Phrase Query</li>
<li>Query String Query</li>
</ul>
</li>
<li>特点<ul>
<li>索引和搜索时都会进行分词，查询字符串先传递到一个合适的分词器，然后生成一个供查询的词项列表</li>
<li>查询的时候，<strong>先对输入的查询进行分词</strong>，然后每个词项逐个进行底层查询，最终将结果进行合并。并为每个文档生成一个算分。例如：查“Matrix reloaded”，实际会查到包括Matrix或者reload的所有结果<br>拆解步骤例如：<br><img data-src="70b658a/AutoCapture_2020-07-12_105807.jpg" alt="Match Query分步骤拆解示例"></li>
</ul>
</li>
</ul>
<h3 id="25-结构化搜索"><a href="#25-结构化搜索" class="headerlink" title="(25)结构化搜索"></a>(25)结构化搜索</h3><h4 id="结构化数据"><a href="#结构化数据" class="headerlink" title="结构化数据"></a>结构化数据</h4><ul>
<li>结构化搜索（Structured search）是指对结构化数据的搜索<ul>
<li>日期、布尔类型和数字都是结构化的</li>
</ul>
</li>
<li>文本也可以是结构化的<ul>
<li>如彩色笔可以有离散的颜色集合：红（read）、绿（green）、蓝（blue）</li>
<li>一个博客可能被标记了标签，例如，分布式（distributed）和搜索（search）</li>
<li>电商网站上的商品都有UPCs（通用产品码）或者其它的唯一标识，它们都需要遵从严格规定的、结构化的格式。</li>
</ul>
</li>
</ul>
<h4 id="ES中的结构化搜索"><a href="#ES中的结构化搜索" class="headerlink" title="ES中的结构化搜索"></a>ES中的结构化搜索</h4><ul>
<li>布尔、时间，日期和数字这类结构化数据：有精确的格式，我们可以对这些格式进行逻辑操作。包括比较数字或时间的范围，或判定两个值的大小。</li>
<li>结构化的文本可以做精确匹配或者部分匹配<ul>
<li>Term查询 | Prefix前缀查询</li>
</ul>
</li>
<li>结构化结果只有“是”或“否”两个值<ul>
<li><strong>根据场景需要，可以决定结构化搜索是否需要打分（constant score）</strong></li>
</ul>
</li>
</ul>
<h4 id="课程代码示例-1"><a href="#课程代码示例-1" class="headerlink" title="课程代码示例"></a>课程代码示例</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br></pre></td><td class="code"><pre><span class="line">#结构化搜索，精确匹配</span><br><span class="line">DELETE products</span><br><span class="line">POST /products/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 10,&quot;avaliable&quot;:true,&quot;date&quot;:&quot;2018-01-01&quot;, &quot;productID&quot; : &quot;XHDK-A-1293-#fJ3&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 20,&quot;avaliable&quot;:true,&quot;date&quot;:&quot;2019-01-01&quot;, &quot;productID&quot; : &quot;KDKE-B-9947-#kL5&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3 &#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 30,&quot;avaliable&quot;:true, &quot;productID&quot; : &quot;JODL-X-1937-#pV7&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 4 &#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 30,&quot;avaliable&quot;:false, &quot;productID&quot; : &quot;QQPX-R-3956-#aD8&quot; &#125;</span><br><span class="line"></span><br><span class="line">GET products/_mapping</span><br><span class="line"># 输出结果</span><br><span class="line">&#123;</span><br><span class="line">  &quot;products&quot; : &#123;</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;avaliable&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;boolean&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;date&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;date&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;price&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;long&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;productID&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot; : &#123;</span><br><span class="line">            &quot;keyword&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot; : 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#对布尔值 match 查询，有算分</span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;avaliable&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#对布尔值，通过constant score 转成 filtering，没有算分</span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;term&quot;: &#123;</span><br><span class="line">          &quot;avaliable&quot;: true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#数字类型 Term</span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;price&quot;: 30</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#数字类型 terms</span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;terms&quot;: &#123;</span><br><span class="line">          &quot;price&quot;: [</span><br><span class="line">            &quot;20&quot;,</span><br><span class="line">            &quot;30&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#数字 Range 查询</span><br><span class="line">GET products/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;constant_score&quot; : &#123;</span><br><span class="line">            &quot;filter&quot; : &#123;</span><br><span class="line">                &quot;range&quot; : &#123;</span><br><span class="line">                    &quot;price&quot; : &#123;</span><br><span class="line">                        &quot;gte&quot; : 20,</span><br><span class="line">                        &quot;lte&quot;  : 30</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 日期 range</span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;constant_score&quot; : &#123;</span><br><span class="line">            &quot;filter&quot; : &#123;</span><br><span class="line">                &quot;range&quot; : &#123;</span><br><span class="line">                    &quot;date&quot; : &#123;</span><br><span class="line">                      &quot;gte&quot; : &quot;now-1y&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#exists查询</span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;exists&quot;: &#123;</span><br><span class="line">          &quot;field&quot;: &quot;date&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#处理多值字段</span><br><span class="line">POST /movies/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class="line">&#123; &quot;title&quot; : &quot;Father of the Bridge Part II&quot;,&quot;year&quot;:1995, &quot;genre&quot;:&quot;Comedy&quot;&#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class="line">&#123; &quot;title&quot; : &quot;Dave&quot;,&quot;year&quot;:1993,&quot;genre&quot;:[&quot;Comedy&quot;,&quot;Romance&quot;] &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#多值字段查询，term查询是包含，而不是等于。</span><br><span class="line">## 要想通过这种方式，精确匹配查询，解决办法是：</span><br><span class="line">## 增加一个genre_count字段进行计数，再组合bool query的方式组合查询</span><br><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;term&quot;: &#123;</span><br><span class="line">          &quot;genre.keyword&quot;: &quot;Comedy&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#字符类型 terms</span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;terms&quot;: &#123;</span><br><span class="line">          &quot;productID.keyword&quot;: [</span><br><span class="line">            &quot;QQPX-R-3956-#aD8&quot;,</span><br><span class="line">            &quot;JODL-X-1937-#pV7&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;price&quot;: 30</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;date&quot;: &quot;2019-01-01&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;date&quot;: &quot;2019-01-01&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;term&quot;: &#123;</span><br><span class="line">          &quot;productID.keyword&quot;: &quot;XHDK-A-1293-#fJ3&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;productID.keyword&quot;: &quot;XHDK-A-1293-#fJ3&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#对布尔数值</span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;term&quot;: &#123;</span><br><span class="line">          &quot;avaliable&quot;: &quot;false&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;avaliable&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;false&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;price&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;20&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;price&quot;: &quot;20&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;bool&quot;: &#123;</span><br><span class="line">          &quot;must_not&quot;: &#123;</span><br><span class="line">            &quot;exists&quot;: &#123;</span><br><span class="line">              &quot;field&quot;: &quot;date&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="26-搜索相关性算法"><a href="#26-搜索相关性算法" class="headerlink" title="(26)搜索相关性算法"></a>(26)搜索相关性算法</h3><h4 id="相关性和相关性算分"><a href="#相关性和相关性算分" class="headerlink" title="相关性和相关性算分"></a>相关性和相关性算分</h4><p>相关性-Relevance</p>
<ul>
<li>搜索的相关性算分，描述了一个文档和查询语句匹配的程度。ES会对每个匹配查询条件的结果进行算分（_score）</li>
<li>打分的本质是排序，需要把符合用户需求的稳定排在前面。ES5之前，默认的相关性算法采用TF-IDF，现在采用BM25<h4 id="词频TF"><a href="#词频TF" class="headerlink" title="词频TF"></a>词频TF</h4></li>
<li>Term Frequency: 检索词在一篇文档中出现的频率<ul>
<li>检索词出现的次数除以文档的总字数</li>
</ul>
</li>
<li>度量一条查询和结果文档相关性的简单方法：简单将搜索中每一个词的TF进行相加<ul>
<li>例如：TF(区块链) + TF(的) + TF(应用)</li>
</ul>
</li>
<li>Stop Word<ul>
<li>“的”在文档中出现了很多次，但是对贡献相关度几乎没有作用，不应该考虑这些词的TF</li>
</ul>
</li>
</ul>
<h4 id="逆文档频率IDF"><a href="#逆文档频率IDF" class="headerlink" title="逆文档频率IDF"></a>逆文档频率IDF</h4><ul>
<li>DF：检索词在所有文档中出现的频率，例如：<ul>
<li>“区块链”在相对比较少的文档中出现</li>
<li>“应用”在相对比较多的文档中出现</li>
<li>“Stop word”在大量的文档中出现</li>
</ul>
</li>
<li>Inverse Document Frequency: 简单说 = log(全部文档数 / 检索词出现过的文档总数)</li>
<li>TF-IDF <strong>本质上就是讲TF求和变成了加权求和</strong>，例如：<ul>
<li>TF(区块链) * IDF(区块链) + TF() * IDF(的) + TF(应用) * IDF(应用)<br><img data-src="70b658a/AutoCapture_2020-07-12_123744.jpg" alt="TF-IDF假设运算结果表">  </li>
</ul>
</li>
</ul>
<h4 id="TF-IDF的概念"><a href="#TF-IDF的概念" class="headerlink" title="TF-IDF的概念"></a>TF-IDF的概念</h4><ul>
<li>TF-IDF被公认为是信息检索领域最重要的发明</li>
<li>除了在信息检索，在文献分类和其他相关领域有着非常广泛的应用</li>
<li>IDF的概念，最早是剑桥大学“斯巴克·琼斯”提出<ul>
<li>1972年，“关键词特殊性的统计解释和它在文献检索中的应用”</li>
<li>但是没有从理论上解释IDF应该是用log(全部文档数 / 检索词出现过的文档总数)，而不是其它函数。也没有做进一步的研究</li>
</ul>
</li>
<li>1970，1980年代萨尔顿和罗宾逊，进行了进一步的证明和研究，并用了香农的信息论做了证明</li>
<li>现代搜索引擎，对TF-IDF进行了大量细微的优化</li>
</ul>
<p>在Lucene中的TF-IDF评分公式：<br><img data-src="70b658a/AutoCapture_2020-07-12_125601.jpg" alt="Lucene中的TF-IDF评分公式"><br>boosting-权重提升因子</p>
<h4 id="BM25"><a href="#BM25" class="headerlink" title="BM25"></a>BM25</h4><ul>
<li>从ES5开始，默认算法改为BM25</li>
<li>和经典的TF-IDF相比，当TF无限增加时，BM25算分会趋于一个数值<br><img data-src="70b658a/AutoCapture_2020-07-12_125752.jpg" alt="BM25-Classic TF算分曲线">  </li>
</ul>
<p>定制Similarity<br><img data-src="70b658a/AutoCapture_2020-07-12_130022.jpg" alt="定制Similarity"> </p>
<p>可以在查询中打开explain开关，开关注算分步骤</p>
<h5 id="Boosting-Relevance"><a href="#Boosting-Relevance" class="headerlink" title="Boosting Relevance"></a>Boosting Relevance</h5><ul>
<li>Boosting是控制相关度的一种手段<ul>
<li>索引，字段或查询子条件</li>
</ul>
</li>
<li>参数boost的含义<ul>
<li>当boost &gt; 1时，打分的相关度相对性提升</li>
<li>当0 &lt; boost &lt; 1时，打分的权重相对性降低</li>
<li>当boost &lt; 0时，贡献负分</li>
</ul>
</li>
</ul>
<h4 id="相关阅读-1"><a href="#相关阅读-1" class="headerlink" title="相关阅读"></a>相关阅读</h4><ul>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Okapi_BM25">Wikipedia-BM25算法</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Tf%E2%80%93idf">Wikipedia-经典TF-IDF算法</a></li>
</ul>
<h3 id="27-Query-amp-Filtering与多字符串多字段查询"><a href="#27-Query-amp-Filtering与多字符串多字段查询" class="headerlink" title="(27)Query &amp; Filtering与多字符串多字段查询"></a>(27)Query &amp; Filtering与多字符串多字段查询</h3><h4 id="Query-Context-amp-Filter-Context"><a href="#Query-Context-amp-Filter-Context" class="headerlink" title="Query Context &amp; Filter Context"></a>Query Context &amp; Filter Context</h4><ul>
<li>高级搜索的功能：支持多项文本输入，针对多个字段进行搜索</li>
<li>搜索引擎一般也提供基于时间，价格等条件的过滤</li>
<li>在ElasticSearch中，有Query和Filter两种不同的Context<ul>
<li>Query Context: 相关性算分</li>
<li>Filter Context: 不需要算法（Yes or No），可以利用Cache，获得更好的性能<h4 id="条件组合示例"><a href="#条件组合示例" class="headerlink" title="条件组合示例"></a>条件组合示例</h4></li>
</ul>
</li>
<li>假设要搜索一本电影，包含了以下条件：<ul>
<li>评论中包含了Guitar，用户打分高于3分，同时上映日期要在1993与2000年之间</li>
</ul>
</li>
<li>这个搜索其实包含了3段逻辑，针对不同的字段：<ul>
<li>评论字段中要包含Guitar/用户评分大于3/上映日期需要在给定的范围</li>
</ul>
</li>
<li>同时包含这三个逻辑，并且有比较好的性能？<ul>
<li>复合查询：bool Query<h4 id="bool查询"><a href="#bool查询" class="headerlink" title="bool查询"></a>bool查询</h4></li>
</ul>
</li>
<li>一个bool查询，是一个或者多个查询子句的组合<ul>
<li>总共包括4种子句。其中2种会影响算分，2种不影响算分</li>
</ul>
</li>
<li>相关性并不只是全文本检索的专利。也适用于 yes | no的子句，匹配的子句越多，相关性评分越高。如果多条查询子句被合并为一条复合查询语句，比如bool查询，则每个查询子句计算得出的评分会被合并到总的相关性评分中。<table>
<thead>
<tr>
<th align="center">搜索关键词</th>
<th align="center">功能释义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">must</td>
<td align="center">必须匹配。贡献算分</td>
</tr>
<tr>
<td align="center">should</td>
<td align="center">选择性匹配。贡献算分</td>
</tr>
<tr>
<td align="center">must_not</td>
<td align="center">Filter Context查询子句，必须不能匹配</td>
</tr>
<tr>
<td align="center">filter</td>
<td align="center">Filter Context必须匹配，但是不贡献算分</td>
</tr>
</tbody></table>
</li>
</ul>
<h5 id="bool查询示例"><a href="#bool查询示例" class="headerlink" title="bool查询示例"></a>bool查询示例</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot; : &#123;</span><br><span class="line">      &quot;must&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;price&quot; : &quot;30&quot; &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;avaliable&quot; : &quot;true&quot; &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;must_not&quot; : &#123;</span><br><span class="line">        &quot;range&quot; : &#123;</span><br><span class="line">          &quot;price&quot; : &#123; &quot;lte&quot; : 10 &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;should&quot; : [</span><br><span class="line">        &#123; &quot;term&quot; : &#123; &quot;productID.keyword&quot; : &quot;JODL-X-1937-#pV7&quot; &#125; &#125;,</span><br><span class="line">        &#123; &quot;term&quot; : &#123; &quot;productID.keyword&quot; : &quot;XHDK-A-1293-#fJ3&quot; &#125; &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;minimum_should_match&quot; :1</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">#改变数据模型，增加字段。解决数组包含而不是精确匹配的问题</span><br><span class="line">POST /newmovies/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class="line">&#123; &quot;title&quot; : &quot;Father of the Bridge Part II&quot;,&quot;year&quot;:1995, &quot;genre&quot;:&quot;Comedy&quot;,&quot;genre_count&quot;:1 &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class="line">&#123; &quot;title&quot; : &quot;Dave&quot;,&quot;year&quot;:1993,&quot;genre&quot;:[&quot;Comedy&quot;,&quot;Romance&quot;],&quot;genre_count&quot;:2 &#125;</span><br><span class="line"></span><br><span class="line">#must，有算分</span><br><span class="line">POST /newmovies/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;&quot;term&quot;: &#123;&quot;genre.keyword&quot;: &#123;&quot;value&quot;: &quot;Comedy&quot;&#125;&#125;&#125;,</span><br><span class="line">        &#123;&quot;term&quot;: &#123;&quot;genre_count&quot;: &#123;&quot;value&quot;: 1&#125;&#125;&#125;</span><br><span class="line"></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="相关度算分影响"><a href="#相关度算分影响" class="headerlink" title="相关度算分影响"></a>相关度算分影响</h5><p>查询语句的结构，会对相关度算分产生影响<br><img data-src="70b658a/AutoCapture_2020-07-26_090151.jpg" alt="相关度算分产生影响示例"></p>
<ul>
<li>同一层级下的竞争字段，具有相同的权重</li>
<li>通过嵌套bool查询，可以改变对算分的影响</li>
</ul>
<h4 id="控制算分字段boosting"><a href="#控制算分字段boosting" class="headerlink" title="控制算分字段boosting"></a>控制算分字段boosting</h4><ul>
<li>Boosting是控制相关度的一种手段<ul>
<li>索引、字段或者查询子条件</li>
</ul>
</li>
<li>参数Boosting的含义<ul>
<li>当boost &gt; 1时，打分的相关度相对性提升</li>
<li>当0 &lt; boost &lt; 1时，打分的权重相对性降低</li>
<li>当0 &lt; boost时，贡献负分</li>
</ul>
</li>
</ul>
<h5 id="boosting示例"><a href="#boosting示例" class="headerlink" title="boosting示例"></a>boosting示例</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">DELETE blogs</span><br><span class="line">POST /blogs/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class="line">&#123;&quot;title&quot;:&quot;Apple iPad&quot;, &quot;content&quot;:&quot;Apple iPad,Apple iPad&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class="line">&#123;&quot;title&quot;:&quot;Apple iPad,Apple iPad&quot;, &quot;content&quot;:&quot;Apple iPad&quot; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;&quot;match&quot;: &#123;</span><br><span class="line">          &quot;title&quot;: &#123;</span><br><span class="line">            &quot;query&quot;: &quot;apple,ipad&quot;,</span><br><span class="line">            &quot;boost&quot;: 1.1</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;&#125;,</span><br><span class="line"></span><br><span class="line">        &#123;&quot;match&quot;: &#123;</span><br><span class="line">          &quot;content&quot;: &#123;</span><br><span class="line">            &quot;query&quot;: &quot;apple,ipad&quot;,</span><br><span class="line">            &quot;boost&quot;:</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">DELETE news</span><br><span class="line">POST /news/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class="line">&#123; &quot;content&quot;:&quot;Apple Mac&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class="line">&#123; &quot;content&quot;:&quot;Apple iPad&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3 &#125;&#125;</span><br><span class="line">&#123; &quot;content&quot;:&quot;Apple employee like Apple Pie and Apple Juice&quot; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST news/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: &#123;</span><br><span class="line">        &quot;match&quot;:&#123;&quot;content&quot;:&quot;apple&quot;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST news/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: &#123;</span><br><span class="line">        &quot;match&quot;:&#123;&quot;content&quot;:&quot;apple&quot;&#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;must_not&quot;: &#123;</span><br><span class="line">        &quot;match&quot;:&#123;&quot;content&quot;:&quot;pie&quot;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">## 搜索相关度降低算分</span><br><span class="line">POST news/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;boosting&quot;: &#123;</span><br><span class="line">      &quot;positive&quot;: &#123;</span><br><span class="line">        &quot;match&quot;: &#123;</span><br><span class="line">          &quot;content&quot;: &quot;apple&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;negative&quot;: &#123;</span><br><span class="line">        &quot;match&quot;: &#123;</span><br><span class="line">          &quot;content&quot;: &quot;pie&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;negative_boost&quot;: 0.5</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="28-单字符串多字段查询Disjunction-Max-Query"><a href="#28-单字符串多字段查询Disjunction-Max-Query" class="headerlink" title="(28)单字符串多字段查询Disjunction Max Query"></a>(28)单字符串多字段查询Disjunction Max Query</h3><h4 id="查询示例"><a href="#查询示例" class="headerlink" title="查询示例"></a>查询示例</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PUT /blogs/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;Quick brown rabbits&quot;,</span><br><span class="line">    &quot;body&quot;:  &quot;Brown rabbits are commonly seen.&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /blogs/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;Keeping pets healthy&quot;,</span><br><span class="line">    &quot;body&quot;:  &quot;My quick brown fox eats rabbits on a regular basis.&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;bool&quot;: &#123;</span><br><span class="line">            &quot;should&quot;: [</span><br><span class="line">                &#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;Brown fox&quot; &#125;&#125;,</span><br><span class="line">                &#123; &quot;match&quot;: &#123; &quot;body&quot;:  &quot;Brown fox&quot; &#125;&#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>假设需要查询下面一个场景：</p>
<ul>
<li>博客标题<ul>
<li>文档1中出现“Brown”</li>
</ul>
</li>
<li>博客内容<ul>
<li>文档1中出现了“Brown”</li>
<li>“Brown fox”在文档2中全部出现，并且保持和查询一致的顺序（目测相关性最高）<h5 id="算分过程解析"><a href="#算分过程解析" class="headerlink" title="算分过程解析"></a>算分过程解析</h5></li>
</ul>
</li>
<li>查询should语句中的两个查询<ul>
<li>文档2虽然包含，但是title不包含</li>
</ul>
</li>
<li>加和两个查询的评分</li>
<li>乘以匹配语句的总数</li>
<li>除以所有语句的总数</li>
</ul>
<h4 id="Disjunction-Max-Query查询"><a href="#Disjunction-Max-Query查询" class="headerlink" title="Disjunction Max Query查询"></a>Disjunction Max Query查询</h4><ul>
<li>上面例子中，title和body相互竞争<ul>
<li>不应该将分数简单叠加，而是应该找到 <strong>单个最佳匹配</strong>的字段的评分</li>
</ul>
</li>
<li>Disjunction Max Query<ul>
<li><strong>将任何与任一查询匹配的文档作为结果返回</strong>。采用字段上最匹配的评分最终评分返回</li>
</ul>
</li>
</ul>
<h5 id="查询示例-1"><a href="#查询示例-1" class="headerlink" title="查询示例"></a>查询示例</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">POST blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;dis_max&quot;: &#123;</span><br><span class="line">            &quot;queries&quot;: [</span><br><span class="line">                &#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;Quick pets&quot; &#125;&#125;,</span><br><span class="line">                &#123; &quot;match&quot;: &#123; &quot;body&quot;:  &quot;Quick pets&quot; &#125;&#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;dis_max&quot;: &#123;</span><br><span class="line">            &quot;queries&quot;: [</span><br><span class="line">                &#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;Quick pets&quot; &#125;&#125;,</span><br><span class="line">                &#123; &quot;match&quot;: &#123; &quot;body&quot;:  &quot;Quick pets&quot; &#125;&#125;</span><br><span class="line">            ],</span><br><span class="line">            # 类似于一个boosting过程</span><br><span class="line">            &quot;tie_breaker&quot;: 0.2</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="Tie-Breaker参数调整"><a href="#Tie-Breaker参数调整" class="headerlink" title="Tie Breaker参数调整"></a>Tie Breaker参数调整</h5><ul>
<li>获得最佳匹配语句的评分</li>
<li>将其它匹配语句的评分与tie_breaker相乘</li>
<li>将以上评分求和并规范化 </li>
</ul>
<h3 id="29-单字符串多字段查询Multi-Match"><a href="#29-单字符串多字段查询Multi-Match" class="headerlink" title="(29)单字符串多字段查询Multi Match"></a>(29)单字符串多字段查询Multi Match</h3><h4 id="三种场景"><a href="#三种场景" class="headerlink" title="三种场景"></a>三种场景</h4><ul>
<li>最佳字段（Best Fields）<ul>
<li>当字段之间相互竞争，又相互关联。例如title和body这样的字段。评分来自最匹配字段</li>
</ul>
</li>
<li>多数字段（Most Fields）<ul>
<li>处理英文内容时：一种常见的手段是，在主字段（English Analyzer），抽取词干，加入同义词，以匹配更多的文档。相同的文本，加入字段（Standard Analyzer），以提供更加精准的匹配。其他字段作为匹配文档提高相关度的信号。匹配字段越多则越好。</li>
</ul>
</li>
<li>混合字段（Cross Fields）<ul>
<li>对于某些实体，例如人名，地址，图书信息。需要在多个字段中确定信息，单个字段只能作为整体的一部分。希望在任何这些列出的字段找到尽可能多的词。</li>
</ul>
</li>
</ul>
<h4 id="Multi-Match-Query"><a href="#Multi-Match-Query" class="headerlink" title="Multi Match Query"></a>Multi Match Query</h4><p>示例查询样例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">POST blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;best_fields&quot;,</span><br><span class="line">      &quot;query&quot;: &quot;Quick pets&quot;,</span><br><span class="line">      &quot;fields&quot;: [&quot;title&quot;,&quot;body&quot;],</span><br><span class="line">      &quot;tie_breaker&quot;: 0.2,</span><br><span class="line">      &quot;minimum_should_match&quot;: &quot;20%&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST books/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">        &quot;query&quot;:  &quot;Quick brown fox&quot;,</span><br><span class="line">        &quot;fields&quot;: &quot;*_title&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST books/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">        &quot;query&quot;:  &quot;Quick brown fox&quot;,</span><br><span class="line">        &quot;fields&quot;: [ &quot;*_title&quot;, &quot;chapter_title^2&quot; ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">########## </span><br><span class="line">PUT /titles</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;english&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST titles/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class="line">&#123; &quot;title&quot;: &quot;My dog barks&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class="line">&#123; &quot;title&quot;: &quot;I see a lot of barking dogs on the road &quot; &#125;</span><br><span class="line"></span><br><span class="line">### 这个查询结果，id=1的查询算分要高于id=2的</span><br><span class="line">### 因为采用了english分词器，默认会把输入的barking dogs，解析为bark dog。</span><br><span class="line">### 这样一来，两片文档命中的term都相同的情况下，由于第一篇文档更短，所以算分较高</span><br><span class="line">GET titles/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &quot;barking dogs&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#### 上述问题，通过增加fileds中指定新的标准分词器，提示查询精确度</span><br><span class="line">DELETE /titles</span><br><span class="line">PUT /titles</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;english&quot;,</span><br><span class="line">        &quot;fields&quot;: &#123;&quot;std&quot;: &#123;&quot;type&quot;: &quot;text&quot;,&quot;analyzer&quot;: &quot;standard&quot;&#125;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST titles/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class="line">&#123; &quot;title&quot;: &quot;My dog barks&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class="line">&#123; &quot;title&quot;: &quot;I see a lot of barking dogs on the road &quot; &#125;</span><br><span class="line"></span><br><span class="line">GET /titles/_search</span><br><span class="line">&#123;</span><br><span class="line">   &quot;query&quot;: &#123;</span><br><span class="line">        &quot;multi_match&quot;: &#123;</span><br><span class="line">            &quot;query&quot;:  &quot;barking dogs&quot;,</span><br><span class="line">            &quot;type&quot;:   &quot;most_fields&quot;,</span><br><span class="line">            &quot;fields&quot;: [ &quot;title&quot;, &quot;title.std&quot; ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>Best Fields 是默认类型，可以不用指定</li>
<li>Minimum should match 等参数可以传递生成的Query中</li>
</ul>
<h4 id="跨字段搜索"><a href="#跨字段搜索" class="headerlink" title="跨字段搜索"></a>跨字段搜索</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">PUT address/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;street&quot; : &quot;5 Poland Street&quot;,</span><br><span class="line">  &quot;city&quot; : &quot;London&quot;,</span><br><span class="line">  &quot;country&quot; : &quot;United Kingdom&quot;,</span><br><span class="line">  &quot;postcode&quot; : &quot;W1V 3DG&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">## 搜索不到指定结果</span><br><span class="line">POST address/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;Poland Street W1V&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;most_fields&quot;,</span><br><span class="line">      &quot;operator&quot;: &quot;and&quot;, </span><br><span class="line">      &quot;fields&quot;: [&quot;street&quot;, &quot;city&quot;, &quot;country&quot;, &quot;postcode&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">## </span><br><span class="line">POST address/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;Poland Street W1V&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;cross_fields&quot;,</span><br><span class="line">      &quot;operator&quot;: &quot;and&quot;, </span><br><span class="line">      &quot;fields&quot;: [&quot;street&quot;, &quot;city&quot;, &quot;country&quot;, &quot;postcode&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>支持使用Operator</li>
<li>与copy_to相比，其中一个优势就是它可以在搜索时为单个字段提升权重。</li>
</ul>
<h3 id="30-多语言及中文分词与检索"><a href="#30-多语言及中文分词与检索" class="headerlink" title="(30)多语言及中文分词与检索"></a>(30)多语言及中文分词与检索</h3><h4 id="自然语言与查询Recall"><a href="#自然语言与查询Recall" class="headerlink" title="自然语言与查询Recall"></a>自然语言与查询Recall</h4><ul>
<li>当处理人类自然语言时，有些情况，尽管搜索和原文不完全匹配，但是希望搜到一些内容<ul>
<li>例如：Quick brown fox 和 Fast brown fox / Jumping fox 和 Jumped foxes</li>
</ul>
</li>
<li>一些可以采取的优化措施：<ul>
<li>归一化词元：清除变音符号，如rôle的时候也会匹配role</li>
<li>抽取词根：清除单复数和时态的差异</li>
<li>包含同义词</li>
<li>拼写错误：拼写错误，或者同音异形词</li>
</ul>
</li>
</ul>
<h4 id="混合多语言挑战"><a href="#混合多语言挑战" class="headerlink" title="混合多语言挑战"></a>混合多语言挑战</h4><ul>
<li>一些具体的多语言场景<ul>
<li>不同的索引使用不同的语言 / 同一个索引中，不同的字段使用不同的语言 / 一个文档的一个字段内混合不同的语言</li>
</ul>
</li>
<li>混合语言存在的一些挑战<ul>
<li>词干提取：以色列文档，可能包含了希伯来语，阿拉伯语，俄语和英语</li>
<li>不正确的文档频率 - 英文为主的文章中，德文算分高（稀有）</li>
<li>需要判断用户搜索时使用的语言，语言识别（Compact Language Detector）<ul>
<li>例如：根据语言，查询不同的索引</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="分词挑战"><a href="#分词挑战" class="headerlink" title="分词挑战"></a>分词挑战</h4><ul>
<li>英文分词：You’re分成一个还是多个？</li>
<li>中文分词：<ul>
<li>分词标准：哈工大标准中，姓和名分开。HanLP是在一起的。具体情况需指定不同的标准</li>
<li>歧义（组合型歧义，交集型歧义，真歧义）<ul>
<li>中华人民共和国/美国会通过对台售武法案/上海仁和服装厂</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="52-Ingest-Pipeline-amp-Painless-Script"><a href="#52-Ingest-Pipeline-amp-Painless-Script" class="headerlink" title="(52)Ingest Pipeline &amp; Painless Script"></a>(52)Ingest Pipeline &amp; Painless Script</h3><h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>当遇到一个输入文档中，某个输入字段不是正常的字符串，而是一个带有逗号的数组，此时需要对对应字段处理并进行Aggregation操作。<br>例如下面的：tags</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT tech_blogs/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;Introducing big data......&quot;,</span><br><span class="line">    &quot;tags&quot;: &quot;hadoop,elasticsearch,spark&quot;,</span><br><span class="line">    &quot;content&quot;: &quot;You know, for big data&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Ingest-Node"><a href="#Ingest-Node" class="headerlink" title="Ingest Node"></a>Ingest Node</h4><p>ElasticSearch 5.0之后，引入的一种新的节点类型。默认配置下，每个节点都是Ingest Node<br>特点：</p>
<ul>
<li>具有预处理数据的能力，可以拦截Index或Bulk API的请求</li>
<li>对数据进行转换，并重新返回给Index或Bulk API</li>
<li>无需Logstash，就可以进行数据预处理，例如：<ul>
<li>为某个字段设置默认值；重命名某个字段的字段名；对字段值进行Split操作</li>
<li>支持设置Painless脚本，对数据进行更加复杂的加工<h5 id="Pipeline-amp-Processor"><a href="#Pipeline-amp-Processor" class="headerlink" title="Pipeline &amp; Processor"></a>Pipeline &amp; Processor</h5>注：类似于Java WEB中的Filter概念<br>Pipeline管道会对通过的数据（文档），按照顺序进行加工。<br>Processor: ElasticSearch对一些加工的行为进行了抽象的包装<br>ElasticSearch有很多内置的Processors，<strong>也可以通过自定义编写插件的方式</strong>，来实现自己的Processor<br><img data-src="70b658a/AutoCapture_2020-06-20_174345.jpg" alt="Pipeline处理"></li>
</ul>
</li>
</ul>
<h5 id="Ingest-Node-v-s-Logstash"><a href="#Ingest-Node-v-s-Logstash" class="headerlink" title="Ingest Node v.s Logstash"></a>Ingest Node v.s Logstash</h5><p><img data-src="70b658a/AutoCapture_2020-06-20_175410.jpg" alt="Ingest Node v.s Logstash"></p>
<h4 id="Painless简介"><a href="#Painless简介" class="headerlink" title="Painless简介"></a>Painless简介</h4><ul>
<li>自ElasticSearch 5.X后引入，专门为ElasticSearch设计，扩展了Java的语法</li>
<li>6.0 开始，ES只支持Painless。Groovy，JavaScript和Python都不再支持</li>
<li>Painless支持所有Java的数据类型及Java API子集</li>
<li>Painless Script具备以下特性：<ul>
<li><p>高性能 &amp; 安全</p>
</li>
<li><p>支持显示类型或者动态定义类型</p>
<h5 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h5></li>
</ul>
</li>
<li>可以对文档字段进行加工处理：<ul>
<li>更新或删除字段，处理数据聚合操作</li>
<li>Script Field: 对返回的字段提前进行计算</li>
<li>Function Score: 对文档的算分进行处理</li>
</ul>
</li>
<li>可以在Ingest Pipeline中执行搅拌</li>
<li>在Reindex API，Update By Query时，对数据进行处理</li>
</ul>
<h5 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">PUT tech_blogs/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;Introducing big data......&quot;,</span><br><span class="line">  &quot;tags&quot;: &quot;hadoop,elasticsearch,spark&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;You know, for big data&quot;,</span><br><span class="line">  &quot;views&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line">## 通过Painless Script来动态更新上述文档中的views数值</span><br><span class="line">POST tech_blogs/_update/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;script&quot;: &#123;</span><br><span class="line">    &quot;source&quot;: &quot;ctx._source.views += params.new_views&quot;,</span><br><span class="line">    &quot;params&quot;: &#123;</span><br><span class="line">      &quot;new_views&quot;: 100</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST tech_blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">## 保存脚本在Cluster State中</span><br><span class="line">POST _scripts/sample_update_views</span><br><span class="line">&#123;</span><br><span class="line">  &quot;script&quot;: &#123;</span><br><span class="line">    &quot;lang&quot;: &quot;painless&quot;,</span><br><span class="line">    &quot;source&quot;: &quot;ctx._source.views += params.new_views&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST tech_blogs/_update/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;script&quot;: &#123;</span><br><span class="line">    &quot;id&quot;: &quot;sample_update_views&quot;,</span><br><span class="line">    &quot;params&quot;: &#123;</span><br><span class="line">      &quot;new_views&quot;: 1000</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST tech_blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意：此种编译脚本编译开销还是比较大的<br><img data-src="70b658a/AutoCapture_2020-06-20_181355.jpg" alt="脚本编译开销"></p>
<h3 id="53-数据建模实例与最佳实践"><a href="#53-数据建模实例与最佳实践" class="headerlink" title="(53)数据建模实例与最佳实践"></a>(53)数据建模实例与最佳实践</h3><h4 id="什么是数据建模？"><a href="#什么是数据建模？" class="headerlink" title="什么是数据建模？"></a>什么是数据建模？</h4><p>数据建模（Data modeling），是创建数据模型的过程</p>
<ul>
<li><strong>数据模型</strong>是对真实世界进行抽象描述的一种工具和方法，实现对显示世界的映射<ul>
<li>博客、作者、用户评论</li>
</ul>
</li>
<li>三个过程：概念模型 =&gt; 逻辑模型 =&gt; <strong>数据模型（第三范式）</strong><ul>
<li>数据模型：结合具体的数据库，在满足业务读写性能等需求的前提下，确定最终的定义</li>
</ul>
</li>
</ul>
<h4 id="数据建模过程"><a href="#数据建模过程" class="headerlink" title="数据建模过程"></a>数据建模过程</h4><p>数据建模过程：功能需求 + 性能需求</p>
<ul>
<li>逻辑模型<ul>
<li>实体属性</li>
<li>实体之间的关系</li>
<li>搜索相关的配置</li>
</ul>
</li>
<li>物理模型<ul>
<li>索引模板<ul>
<li>分片的数量</li>
</ul>
</li>
<li>索引的Mapping<ul>
<li>字段配置：字段是否需要被搜索、字段是否需要被聚合</li>
<li>关系处理</li>
</ul>
</li>
</ul>
</li>
<li>数据需求<ul>
<li>索引与分配</li>
<li>文档</li>
<li>字段</li>
</ul>
</li>
</ul>
<h4 id="建模步骤"><a href="#建模步骤" class="headerlink" title="建模步骤"></a>建模步骤</h4><p>确定字段类型 =&gt; 字段是否要搜索及分词 =&gt; 字段是否需要聚合及排序 =&gt; 字段是否需要额外的存储</p>
<h5 id="字段类型：Text-v-s-Keyword"><a href="#字段类型：Text-v-s-Keyword" class="headerlink" title="字段类型：Text v.s Keyword"></a>字段类型：Text v.s Keyword</h5><ul>
<li>Text<ul>
<li>用于全文本字段，文本会被Analyzer分词</li>
<li><strong>默认不支持聚合分析</strong>及排序。需要设置fielddata为true</li>
</ul>
</li>
<li>Keyword<ul>
<li>用于id，枚举及不需要分词的文本。例如：电话号码，email地址，手机号码，邮政编码，性别等</li>
<li>适用于Filter（精确匹配），Sorting和Aggregations</li>
</ul>
</li>
<li>设置多字段类型<ul>
<li>默认会为文本类型设置成为text，并且设置一个keyword的子字段</li>
<li>在处理人类语言时，通过增加“英文”，“拼音”和“标准”分词器，提高搜索结构</li>
</ul>
</li>
</ul>
<h5 id="字段类型：结构化数据"><a href="#字段类型：结构化数据" class="headerlink" title="字段类型：结构化数据"></a>字段类型：结构化数据</h5><ul>
<li>数值类型<ul>
<li>尽量选择贴近的类型。例如可以用byte，就不要用long</li>
</ul>
</li>
<li>枚举类型<ul>
<li>设置为keyword。即便是数字，也应该设置成keyword，获取更好的性能</li>
</ul>
</li>
<li>其它<ul>
<li>日期、布尔、地理信息等</li>
</ul>
</li>
</ul>
<h5 id="搜索角度"><a href="#搜索角度" class="headerlink" title="搜索角度"></a>搜索角度</h5><ul>
<li>如果不需要检索，排序和聚合分析<ul>
<li>Enable设置成false</li>
</ul>
</li>
<li>如果不需要检索<ul>
<li>Index设置成false</li>
</ul>
</li>
<li>对需要检索的字段，可以通过如下配置，设定存储粒度<ul>
<li>Index options / Norms: 不需要归一化数据时，可以关闭</li>
</ul>
</li>
</ul>
<h5 id="聚合及排序角度"><a href="#聚合及排序角度" class="headerlink" title="聚合及排序角度"></a>聚合及排序角度</h5><ul>
<li>如果不需要检索，排序和聚合分析<ul>
<li>Enable设置成false</li>
</ul>
</li>
<li>如果不需要排序或者聚合分析功能<ul>
<li>Doc_values / fielddata 设置成false</li>
</ul>
</li>
<li>更新频繁，聚合查询频繁的keyword类型的字段<ul>
<li>推荐奖eager_global_ordinals设置成true。（利用缓存特性，提供Terms &amp; Aggregations的性能）</li>
</ul>
</li>
</ul>
<h5 id="额外存储角度"><a href="#额外存储角度" class="headerlink" title="额外存储角度"></a>额外存储角度</h5><ul>
<li>是否需要专门存储当前字段数据<ul>
<li>Store设置成true，可以存储该字段的原始内容</li>
<li>一般结合_source的enabled为false适合使用</li>
</ul>
</li>
<li>Disable _source 后 : 节约磁盘；适用于指标型数据<ul>
<li>所以通常：一般建议先考虑增加压缩比</li>
<li>因为：无法看到 _source字段，无法做Reindex，无法做Update</li>
</ul>
</li>
</ul>
<h4 id="一个数据建模的案例"><a href="#一个数据建模的案例" class="headerlink" title="一个数据建模的案例"></a>一个数据建模的案例</h4><p><img data-src="70b658a/AutoCapture_2020-06-29_222348.jpg" alt="一个图书索引信息"><br>解释备注：</p>
<ul>
<li>这是一个图书信息，包含：书名、简介、作者、发行日期、图书封面</li>
<li>默认Mapping的时候，会把“图书封面”设置成一个text类型，还加了一个子的字段keyword。</li>
</ul>
<p>优化：<br><img data-src="70b658a/AutoCapture_2020-06-29_222750.jpg" alt="一个图书索引信息"><br>解释备注：</p>
<ul>
<li>“图书封面”一般不会去检索</li>
</ul>
<h5 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h5><h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2>
    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>nimbusk
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://nimbusk.cc/post/70b658a.html" title="极客时间-ElasticSearch">https://nimbusk.cc/post/70b658a.html</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="followme">
  <span>欢迎关注我的其它发布渠道</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/ElasticSearch/" rel="tag"># ElasticSearch</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/5a5ddfe.html" rel="prev" title="Sony α7III Mk拍摄设置技巧">
                  <i class="fa fa-angle-left"></i> Sony α7III Mk拍摄设置技巧
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/52d27346.html" rel="next" title="极客时间-深入拆解Java虚拟机">
                  极客时间-深入拆解Java虚拟机 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">nimbusk</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>

  <script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.3.0/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script>
  <script src="/js/third-party/tags/pdf.js"></script>

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.1/mermaid.min.js","integrity":"sha256-YbM1pG3wWnzhyYN49g5fPnen+2CKEFaZfopkkwSpNtY="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>


  <script src="/js/third-party/fancybox.js"></script>



  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"nimbusking","repo":"blog_comments","client_id":"3ba56d7e4658bddb03ae","client_secret":"7f7dae0b54cbd02df9ced28e9f1ce739f94e33d4","admin_user":"nimbusking","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"en|zh-CN|zh-TW","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"c633e9a5e4c581bf956292c8fe89d137"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
